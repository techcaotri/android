
<!DOCTYPE HTML>
<html lang="" >
    <head>
        <meta charset="UTF-8">
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <title>Live555 - Live555 source code analysis_mediaserver Â· GitBook</title>
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="description" content="">
        <meta name="generator" content="@gitbook-ng/gitbook 3.3.6">
        
        
        
    
    <link rel="stylesheet" href="gitbook/style.css">

    
            
                
                <link rel="stylesheet" href="gitbook/gitbook-plugin-fancybox/jquery.fancybox.css">
                
            
                
                <link rel="stylesheet" href="gitbook/gitbook-plugin-fancybox/jquery.fancybox-buttons.css">
                
            
                
                <link rel="stylesheet" href="gitbook/gitbook-plugin-anchor-navigation-ex-toc/style/plugin.css">
                
            
                
                <link rel="stylesheet" href="gitbook/gitbook-plugin-ace/ace.css">
                
            
                
                <link rel="stylesheet" href="gitbook/gitbook-plugin-search-plus/search.css">
                
            
                
                <link rel="stylesheet" href="gitbook/gitbook-plugin-splitter/splitter.css">
                
            
                
                <link rel="stylesheet" href="gitbook/gitbook-plugin-expandable-chapters-interactive/expandable-chapters.css">
                
            
                
                <link rel="stylesheet" href="gitbook/gitbook-plugin-wide-page/wide.css">
                
            
                
                <link rel="stylesheet" href="gitbook/gitbook-plugin-highlight/website.css">
                
            
                
                <link rel="stylesheet" href="gitbook/gitbook-plugin-fontsettings/website.css">
                
            
        

    

    
        
        <link rel="stylesheet" href="styles/website.css">
        
    

        
    
    
    <meta name="HandheldFriendly" content="true"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="apple-touch-icon-precomposed" sizes="152x152" href="gitbook/images/apple-touch-icon-precomposed-152.png">
    <link rel="shortcut icon" href="gitbook/images/favicon.ico" type="image/x-icon">

    
    <link rel="next" href="Live555 - Wireshark capture packet analysis RTSP_RTP_RTCP basic working process.html" />
    
    
    <link rel="prev" href="Live555 - Live555 source code analysis_infrastructure.html" />
    

    </head>
    <body>
        
<div class="book">
    <div class="book-summary">
        
            
<div id="book-search-input" role="search">
    <input type="text" placeholder="Type to search" />
</div>

            
                <nav role="navigation">
                


<ul class="summary">
    
    

    

    
        
        
    
        <li class="chapter " data-level="1.1" data-path="./">
            
                <a href="./">
            
                    
                    Introduction
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2" >
            
                <span>
            
                    
                    Graphical Android
            
                </span>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.2.1" data-path="Graphical Android - Zygote, System Server startup analysis.html">
            
                <a href="Graphical Android - Zygote, System Server startup analysis.html">
            
                    
                    Graphical Android - Zygote, System Server startup analysis
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.3" >
            
                <span>
            
                    
                    Android Permissions
            
                </span>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.3.1" data-path="Android Permissions - Android Runtime Permission.html">
            
                <a href="Android Permissions - Android Runtime Permission.html">
            
                    
                    Android Permissions - Android Runtime Permission
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.2" data-path="Android Permissions - Android grantRuntimePermission Detailed.html">
            
                <a href="Android Permissions - Android grantRuntimePermission Detailed.html">
            
                    
                    Android Permissions - Android grantRuntimePermission Detailed
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.3" data-path="Android Permissions - Android GrantPermissionsActivity Detailed.html">
            
                <a href="Android Permissions - Android GrantPermissionsActivity Detailed.html">
            
                    
                    Android Permissions - Android GrantPermissionsActivity Detailed
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.4" data-path="Android Permissions - AppOps control for Normal permission.html">
            
                <a href="Android Permissions - AppOps control for Normal permission.html">
            
                    
                    Android Permissions - AppOps control for Normal permission
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.5" data-path="Android Permissions - Android native permission control process.html">
            
                <a href="Android Permissions - Android native permission control process.html">
            
                    
                    Android Permissions - Android native permission control process
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.6" data-path="Android Permissions - The difference between setUidMode and setMode in AppOps.html">
            
                <a href="Android Permissions - The difference between setUidMode and setMode in AppOps.html">
            
                    
                    Android Permissions - The difference between setUidMode and setMode in AppOps
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.7" data-path="Android Permissions - Application permissions before android M and application permissions after M.html">
            
                <a href="Android Permissions - Application permissions before android M and application permissions after M.html">
            
                    
                    Android Permissions - Application permissions before android M and application permissions after M
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.8" data-path="Android Permissions - Provider permissions detailed.html">
            
                <a href="Android Permissions - Provider permissions detailed.html">
            
                    
                    Android Permissions - Provider permissions detailed
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.4" >
            
                <span>
            
                    
                    Android OTA
            
                </span>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.4.1" data-path="Android OTA - Android OTA upgrade principle and process analysis 1.html">
            
                <a href="Android OTA - Android OTA upgrade principle and process analysis 1.html">
            
                    
                    Android OTA - Android OTA upgrade principle and process analysis 1
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.2" data-path="Android OTA - Android OTA upgrade principle and process analysis 2.html">
            
                <a href="Android OTA - Android OTA upgrade principle and process analysis 2.html">
            
                    
                    Android OTA - Android OTA upgrade principle and process analysis 2
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.3" data-path="Android OTA - Android OTA upgrade principle and process analysis 3.html">
            
                <a href="Android OTA - Android OTA upgrade principle and process analysis 3.html">
            
                    
                    Android OTA - Android OTA upgrade principle and process analysis 3
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.4" data-path="Android OTA - Android OTA upgrade principle and process analysis 4.html">
            
                <a href="Android OTA - Android OTA upgrade principle and process analysis 4.html">
            
                    
                    Android OTA - Android OTA upgrade principle and process analysis 4
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.5" data-path="Android OTA - Android OTA upgrade principle and process analysis 5.html">
            
                <a href="Android OTA - Android OTA upgrade principle and process analysis 5.html">
            
                    
                    Android OTA - Android OTA upgrade principle and process analysis 5
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.6" data-path="Android OTA - Android OTA upgrade principle and process analysis 6.html">
            
                <a href="Android OTA - Android OTA upgrade principle and process analysis 6.html">
            
                    
                    Android OTA - Android OTA upgrade principle and process analysis 6
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.7" data-path="Android OTA - Android OTA upgrade principle and process analysis 7.html">
            
                <a href="Android OTA - Android OTA upgrade principle and process analysis 7.html">
            
                    
                    Android OTA - Android OTA upgrade principle and process analysis 7
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.8" data-path="Android OTA - Android OTA upgrade principle and process analysis 8.html">
            
                <a href="Android OTA - Android OTA upgrade principle and process analysis 8.html">
            
                    
                    Android OTA - Android OTA upgrade principle and process analysis 8
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.9" data-path="Android OTA - Android OTA upgrade principle and process analysis 9.html">
            
                <a href="Android OTA - Android OTA upgrade principle and process analysis 9.html">
            
                    
                    Android OTA - Android OTA upgrade principle and process analysis 9
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.5" >
            
                <span>
            
                    
                    Android Package Manager Service (PMS)
            
                </span>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.5.1" data-path="Android PMS - Explore the Android PMS service.html">
            
                <a href="Android PMS - Explore the Android PMS service.html">
            
                    
                    Android PMS - Explore the Android PMS service
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.2" data-path="Android PMS - Some rules of the PMS runtime.html">
            
                <a href="Android PMS - Some rules of the PMS runtime.html">
            
                    
                    Android PMS - Some rules of the PMS runtime
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.3" data-path="Android PMS - Android 6 PMS Analysis.html">
            
                <a href="Android PMS - Android 6 PMS Analysis.html">
            
                    
                    Android PMS - Android 6 PMS Analysis
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.4" data-path="Android PMS - Android 6 PMS analysis article 1.html">
            
                <a href="Android PMS - Android 6 PMS analysis article 1.html">
            
                    
                    Android PMS - Android 6 PMS analysis article 1
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.5" data-path="Android PMS - Android 6 PMS analysis article 2.html">
            
                <a href="Android PMS - Android 6 PMS analysis article 2.html">
            
                    
                    Android PMS - Android 6 PMS analysis article 2
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.6" data-path="Android PMS - Android 6 PMS analysis of the next article.html">
            
                <a href="Android PMS - Android 6 PMS analysis of the next article.html">
            
                    
                    Android PMS - Android 6 PMS analysis of the next article
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.7" data-path="Android PMS - Android 6 PMS install APK prelude.html">
            
                <a href="Android PMS - Android 6 PMS install APK prelude.html">
            
                    
                    Android PMS - Android 6 PMS install APK prelude
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.8" data-path="Android PMS - Android 6 PMS installation APK.html">
            
                <a href="Android PMS - Android 6 PMS installation APK.html">
            
                    
                    Android PMS - Android 6 PMS installation APK
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.9" data-path="Android PMS - Android 6 PMS installation APK next article.html">
            
                <a href="Android PMS - Android 6 PMS installation APK next article.html">
            
                    
                    Android PMS - Android 6 PMS installation APK next article
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.10" data-path="Android PMS - Android 6 PMS Uninstall APK.html">
            
                <a href="Android PMS - Android 6 PMS Uninstall APK.html">
            
                    
                    Android PMS - Android 6 PMS Uninstall APK
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.11" data-path="Android PMS - Android 6 PMS daemon installd.html">
            
                <a href="Android PMS - Android 6 PMS daemon installd.html">
            
                    
                    Android PMS - Android 6 PMS daemon installd
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.6" >
            
                <span>
            
                    
                    Android AOSP
            
                </span>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.6.1" data-path="Android AOSP - Debugging AOSP Platform code with Android Studio - Java Debugger.html">
            
                <a href="Android AOSP - Debugging AOSP Platform code with Android Studio - Java Debugger.html">
            
                    
                    Android AOSP - Debugging AOSP Platform code with Android Studio - Java Debugger
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.2" data-path="Android AOSP - Modify applications and rebuild emulator image effectively.html">
            
                <a href="Android AOSP - Modify applications and rebuild emulator image effectively.html">
            
                    
                    Android AOSP - Modify applications and rebuild emulator image effectively
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.7" >
            
                <span>
            
                    
                    Android General
            
                </span>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.7.1" data-path="Android General - Reliable connection to AIDL IPC Service in Android.html">
            
                <a href="Android General - Reliable connection to AIDL IPC Service in Android.html">
            
                    
                    Android General - Reliable connection to AIDL IPC Service in Android
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.8" >
            
                <span>
            
                    
                    Android Binder
            
                </span>
            

            
        </li>
    
        <li class="chapter " data-level="1.9" >
            
                <span>
            
                    
                    Android Activity Manager Service (AMS)
            
                </span>
            

            
        </li>
    
        <li class="chapter " data-level="1.10" >
            
                <span>
            
                    
                    Live555
            
                </span>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.10.1" data-path="Live555 - Live555 source code analysis_introduction.html">
            
                <a href="Live555 - Live555 source code analysis_introduction.html">
            
                    
                    Live555 - Live555 source code analysis_introduction
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.10.2" data-path="Live555 - Live555 source code analysis_infrastructure.html">
            
                <a href="Live555 - Live555 source code analysis_infrastructure.html">
            
                    
                    Live555 - Live555 source code analysis_infrastructure
            
                </a>
            

            
        </li>
    
        <li class="chapter active" data-level="1.10.3" data-path="Live555 - Live555 source code analysis_mediaserver.html">
            
                <a href="Live555 - Live555 source code analysis_mediaserver.html">
            
                    
                    Live555 - Live555 source code analysis_mediaserver
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.10.4" data-path="Live555 - Wireshark capture packet analysis RTSP_RTP_RTCP basic working process.html">
            
                <a href="Live555 - Wireshark capture packet analysis RTSP_RTP_RTCP basic working process.html">
            
                    
                    Live555 - Wireshark capture packet analysis RTSP_RTP_RTCP basic working process
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.10.5" data-path="Live555 - Live555 source code analysis_rtspserver.html">
            
                <a href="Live555 - Live555 source code analysis_rtspserver.html">
            
                    
                    Live555 - Live555 source code analysis_rtspserver
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.10.6" data-path="Live555 - Live555 source code analysis_describe processing.html">
            
                <a href="Live555 - Live555 source code analysis_describe processing.html">
            
                    
                    Live555 - Live555 source code analysis_describe processing
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.10.7" data-path="Live555 - Live555 source code analysis_setup processing.html">
            
                <a href="Live555 - Live555 source code analysis_setup processing.html">
            
                    
                    Live555 - Live555 source code analysis_setup processing
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.10.8" data-path="Live555 - Live555 source code analysis_play processing.html">
            
                <a href="Live555 - Live555 source code analysis_play processing.html">
            
                    
                    Live555 - Live555 source code analysis_play processing
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.10.9" data-path="Live555 - Live555 source code analysis_RTSPServer component structure.html">
            
                <a href="Live555 - Live555 source code analysis_RTSPServer component structure.html">
            
                    
                    Live555 - Live555 source code analysis_RTSPServer component structure
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.10.10" data-path="Live555 - Live555 source code analysis_servermediasession.html">
            
                <a href="Live555 - Live555 source code analysis_servermediasession.html">
            
                    
                    Live555 - Live555 source code analysis_servermediasession
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.10.11" data-path="Live555 - Live555 source code analysis_subsession SDP line generation.html">
            
                <a href="Live555 - Live555 source code analysis_subsession SDP line generation.html">
            
                    
                    Live555 - Live555 source code analysis_subsession SDP line generation
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.10.12" data-path="Live555 - Live555 source code analysis_Subsession SETUP.html">
            
                <a href="Live555 - Live555 source code analysis_Subsession SETUP.html">
            
                    
                    Live555 - Live555 source code analysis_Subsession SETUP
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.10.13" data-path="Live555 - Live555 source code analysis_play start.html">
            
                <a href="Live555 - Live555 source code analysis_play start.html">
            
                    
                    Live555 - Live555 source code analysis_play start
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.11" >
            
                <span>
            
                    
                    Flutter
            
                </span>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.11.1" data-path="Flutter Framework Analysis 1 - Overview and Window.html">
            
                <a href="Flutter Framework Analysis 1 - Overview and Window.html">
            
                    
                    Flutter Framework Analysis 1 - Overview and Window
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.11.2" data-path="Flutter Framework Analysis 2 - Initialization.html">
            
                <a href="Flutter Framework Analysis 2 - Initialization.html">
            
                    
                    Flutter Framework Analysis 2 - Initialization
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.11.3" data-path="Flutter Framework Analysis 3 - Widget, Element and RenderObject.html">
            
                <a href="Flutter Framework Analysis 3 - Widget, Element and RenderObject.html">
            
                    
                    Flutter Framework Analysis 3 - Widget, Element and RenderObject
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.11.4" data-path="Flutter Framework Analysis 4 - Flutter Framework Operation.html">
            
                <a href="Flutter Framework Analysis 4 - Flutter Framework Operation.html">
            
                    
                    Flutter Framework Analysis 4 - Flutter Framework Operation
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.11.5" data-path="Flutter Framework Analysis 5 - Animation.html">
            
                <a href="Flutter Framework Analysis 5 - Animation.html">
            
                    
                    Flutter Framework Analysis 5 - Animation
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.11.6" data-path="Flutter Framework Analysis 6 - Layout.html">
            
                <a href="Flutter Framework Analysis 6 - Layout.html">
            
                    
                    Flutter Framework Analysis 6 - Layout
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.11.7" data-path="Flutter Framework Analysis 7 - Drawing.html">
            
                <a href="Flutter Framework Analysis 7 - Drawing.html">
            
                    
                    Flutter Framework Analysis 7 - Drawing
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    

    
</ul>


                </nav>
            
        
    </div>

    <div class="book-body">
        
            <div class="body-inner">
                
                    

<div class="book-header" role="navigation">
    

    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href="." >Live555 - Live555 source code analysis_mediaserver</a>
    </h1>
</div>




                    <div class="page-wrapper" tabindex="-1" role="main">
                        <div class="page-inner">
                            
<div class="search-plus" id="book-search-results">
    <div class="search-noresults">
    
                                <section class="normal markdown-section">
                                
                                <div id="anchor-navigation-ex-navbar"><i class="fa fa-anchor"></i><ul><li><span class="title-icon "></span><a href="#live555-source-code-analysis-mediasever"><b>1. </b>Live555 Source code analysis: MediaSever</a></li><ul><li><span class="title-icon "></span><a href="#server-socket-creation-and-connection-establishment"><b>1.1. </b>Server socket creation and connection establishment</a></li><li><span class="title-icon "></span><a href="#live555-source-code-analysis-series"><b>1.2. </b>Live555 source code analysis series</a></li></ul></ul></div><a href="#live555-source-code-analysis-mediasever" id="anchorNavigationExGoTop"><i class="fa fa-arrow-up"></i></a><h1 id="live555-source-code-analysis-mediasever"><a name="live555-source-code-analysis-mediasever" class="anchor-navigation-ex-anchor" href="#live555-source-code-analysis-mediasever"><i class="fa fa-link" aria-hidden="true"></i></a>1. Live555 Source code analysis: MediaSever</h1>
<p> Posted on 2017-08-31 |  In <a href="https://www.wolfcstech.com/categories/live555/" target="_blank">live555</a></p>
<!-- TOC depthFrom:1 depthTo:6 withLinks:1 updateOnSave:0 orderedList:0 -->
<ul>
<li><a href="#live555-source-code-analysis-mediasever"><strong>Live555 Source code analysis: MediaSever</strong></a><ul>
<li><a href="#server-socket-creation-and-connection-establishment"><strong>Server socket creation and connection establishment</strong></a></li>
<li><a href="#live555-source-code-analysis-series"><strong>Live555 source code analysis series</strong></a></li>
</ul>
</li>
</ul>
<!-- /TOC -->
<p>Located in the mediaServer directory of the live555 project is &quot;LIVE555 Media
Server&quot;, which is a complete RTSP server application. It can turn a variety of
media files into a stream and provide them to the requester.</p>
<p>Let&apos;s take a look at the implementation of &quot;LIVE555 Media Server&quot;. Aside from
the code in which the application information is output to the terminal, the
code of the &quot;LIVE555 Media Server&quot; main program looks like this:</p>
<div class="ace"><div class="aceCode" data-config="{&quot;edit&quot;:false,&quot;lang&quot;:&quot;c_cpp&quot;,&quot;check&quot;:false,&quot;theme&quot;:&quot;monokai&quot;}">#include &lt;BasicUsageEnvironment.hh&gt;
#include &quot;DynamicRTSPServer.hh&quot;
#include &quot;version.hh&quot;
int main(int argc, char** argv) {
  // Begin by setting up our usage environment:
  TaskScheduler* scheduler = BasicTaskScheduler::createNew();
  UsageEnvironment* env = BasicUsageEnvironment::createNew(*scheduler);
  UserAuthenticationDatabase* authDB = NULL;
#ifdef ACCESS_CONTROL
  // To implement client access control to the RTSP server, do the following:
  authDB = new UserAuthenticationDatabase;
  authDB-&gt;addUserRecord(&quot;username1&quot;, &quot;password1&quot;); // replace these with real strings
  // Repeat the above with each &lt;username&gt;, &lt;password&gt; that you wish to allow
  // access to the server.
#endif
  // Create the RTSP server.  Try first with the default port number (554),
  // and then with the alternative port number (8554):
  RTSPServer* rtspServer;
  portNumBits rtspServerPortNum = 554;
  rtspServer = DynamicRTSPServer::createNew(*env, rtspServerPortNum, authDB);
  if (rtspServer == NULL) {
    rtspServerPortNum = 8554;
    rtspServer = DynamicRTSPServer::createNew(*env, rtspServerPortNum, authDB);
  }
  if (rtspServer == NULL) {
    *env &lt;&lt; &quot;Failed to create RTSP server: &quot; &lt;&lt; env-&gt;getResultMsg() &lt;&lt; &quot;\n&quot;;
    exit(1);
  }
  . . . . . .
  if (rtspServer-&gt;setUpTunnelingOverHTTP(80) || rtspServer-&gt;setUpTunnelingOverHTTP(8000) || rtspServer-&gt;setUpTunnelingOverHTTP(8080)) {
    *env &lt;&lt; &quot;(We use port &quot; &lt;&lt; rtspServer-&gt;httpServerPortNum() &lt;&lt; &quot; for optional RTSP-over-HTTP tunneling, or for HTTP live streaming (for indexed Transport Stream files only).)\n&quot;;
  } else {
    *env &lt;&lt; &quot;(RTSP-over-HTTP tunneling is not available.)\n&quot;;
  }
  env-&gt;taskScheduler().doEventLoop(); // does not return
  return 0; // only to prevent compiler warning
}<br></div></div>

<p>The main program of &quot;LIVE555 Media Server&quot; is very simple, and the only thing to
do is as follows:</p>
<ol>
<li><p>Created <code>TaskScheduler</code> for performing a task scheduling. 
About <code>TaskScheduler</code> more detailed information refer to <a href="http://www.jianshu.com/p/199048a9c959" target="_blank">live555 source code analysis: infrastructure</a> .</p>
</li>
<li><p>Creating <code>UsageEnvironment</code> a log output, I / O
operations. About UsageEnvironmentmore detailed information refer
to <a href="http://www.jianshu.com/p/199048a9c959" target="_blank">live555 source code analysis:infrastructure</a> .</p>
</li>
<li><p>Create <code>RTSPServer</code> for accepting connections, processing request and the
like. Here we will try to use port 554 first. If it fails, try to use port</p>
<ol>
<li>If both ports are unusable, it will fail to exit the program.</li>
</ol>
</li>
<li><p>To <code>RTSPServer</code> set up HTTP tunneling port. Here we will try to use the 80,
8000 and 8080 ports in turn.</p>
</li>
<li><p>Execute the event loop.</p>
</li>
</ol>
<p><code>TaskScheduler</code> For performing a task scheduling, but listening socket, and the
handler I/O event on the socket, it is necessary <code>RTSPServer</code>,
is <code>DynamicRTSPServer</code> provided. <code>DynamicRTSPServer</code> It is the core of the &quot;LIVE555
Media Server&quot; application and is defined as follows:</p>
<div class="ace"><div class="aceCode" data-config="{&quot;edit&quot;:false,&quot;lang&quot;:&quot;c_cpp&quot;,&quot;check&quot;:false,&quot;theme&quot;:&quot;monokai&quot;}">#ifndef _RTSP_SERVER_SUPPORTING_HTTP_STREAMING_HH
#include &quot;RTSPServerSupportingHTTPStreaming.hh&quot;
#endif
class DynamicRTSPServer: public RTSPServerSupportingHTTPStreaming {
public:
  static DynamicRTSPServer* createNew(UsageEnvironment&amp; env, Port ourPort,
                      UserAuthenticationDatabase* authDatabase,
                      unsigned reclamationTestSeconds = 65);
protected:
  DynamicRTSPServer(UsageEnvironment&amp; env, int ourSocket, Port ourPort,
            UserAuthenticationDatabase* authDatabase, unsigned reclamationTestSeconds);
  // called only by createNew();
  virtual ~DynamicRTSPServer();
protected: // redefined virtual functions
  virtual ServerMediaSession*
  lookupServerMediaSession(char const* streamName, Boolean isFirstLookupInSession);
};<br></div></div>

<p><code>DynamicRTSPServer</code> The class hierarchy is as follows:</p>
<p>     <a href="media/80036cefc18a937d027f3b89e2e45573.png" rel="grouped" title="https://www.wolfcstech.com/images/1315506-791dcd5f2574c420.png" target="_self" class="fancybox">
       <img src="media/80036cefc18a937d027f3b89e2e45573.png" alt="https://www.wolfcstech.com/images/1315506-791dcd5f2574c420.png">
     </a></p>
<p>To listen socket and handler on the socket I/O events is
in <code>DynamicRTSPServer</code> the process of creating the registration
to the <code>TaskScheduler</code>. <code>DynamicRTSPServer</code> Through its static function needs
to <code>createNew()</code> create the function is defined as follows:</p>
<div class="ace"><div class="aceCode" data-config="{&quot;edit&quot;:false,&quot;lang&quot;:&quot;c_cpp&quot;,&quot;check&quot;:false,&quot;theme&quot;:&quot;monokai&quot;}">DynamicRTSPServer*
DynamicRTSPServer::createNew(UsageEnvironment&amp; env, Port ourPort,
                 UserAuthenticationDatabase* authDatabase,
                 unsigned reclamationTestSeconds) {
  int ourSocket = setUpOurSocket(env, ourPort);
  if (ourSocket == -1) return NULL;
  return new DynamicRTSPServer(env, ourSocket, ourPort, authDatabase, reclamationTestSeconds);
}
DynamicRTSPServer::DynamicRTSPServer(UsageEnvironment&amp; env, int ourSocket,
                     Port ourPort,
                     UserAuthenticationDatabase* authDatabase, unsigned reclamationTestSeconds)
  : RTSPServerSupportingHTTPStreaming(env, ourSocket, ourPort, authDatabase, reclamationTestSeconds) {
}<br></div></div>

<p>In <code>DynamicRTSPServer</code> the <code>createNew()</code>, first create a socket, and then use this to
create a socket <code>DynamicRTSPServer</code> object. The constructor goes along the first
level of the class inheritance hierarchy.</p>
<p><code>RTSPServerSupportingHTTPStreaming</code> The constructor is defined as follows:</p>
<div class="ace"><div class="aceCode" data-config="{&quot;edit&quot;:false,&quot;lang&quot;:&quot;c_cpp&quot;,&quot;check&quot;:false,&quot;theme&quot;:&quot;monokai&quot;}">RTSPServerSupportingHTTPStreaming
::RTSPServerSupportingHTTPStreaming(UsageEnvironment&amp; env, int ourSocket, Port rtspPort,
                    UserAuthenticationDatabase* authDatabase, unsigned reclamationTestSeconds)
  : RTSPServer(env, ourSocket, rtspPort, authDatabase, reclamationTestSeconds) {
}<br></div></div>

<p><code>RTSPServer</code> The constructor is defined as follows:</p>
<div class="ace"><div class="aceCode" data-config="{&quot;edit&quot;:false,&quot;lang&quot;:&quot;c_cpp&quot;,&quot;check&quot;:false,&quot;theme&quot;:&quot;monokai&quot;}">RTSPServer::RTSPServer(UsageEnvironment&amp; env,
               int ourSocket, Port ourPort,
               UserAuthenticationDatabase* authDatabase,
               unsigned reclamationSeconds)
  : GenericMediaServer(env, ourSocket, ourPort, reclamationSeconds),
    fHTTPServerSocket(-1), fHTTPServerPort(0),
    fClientConnectionsForHTTPTunneling(NULL), // will get created if needed
    fTCPStreamingDatabase(HashTable::create(ONE_WORD_HASH_KEYS)),
    fPendingRegisterOrDeregisterRequests(HashTable::create(ONE_WORD_HASH_KEYS)),
    fRegisterOrDeregisterRequestCounter(0), fAuthDB(authDatabase), fAllowStreamingRTPOverTCP(True) {
}<br></div></div>

<p><code>GenericMediaServer</code> The constructor is defined as follows:</p>
<div class="ace"><div class="aceCode" data-config="{&quot;edit&quot;:false,&quot;lang&quot;:&quot;c_cpp&quot;,&quot;check&quot;:false,&quot;theme&quot;:&quot;monokai&quot;}">GenericMediaServer
::GenericMediaServer(UsageEnvironment&amp; env, int ourSocket, Port ourPort,
             unsigned reclamationSeconds)
  : Medium(env),
    fServerSocket(ourSocket), fServerPort(ourPort), fReclamationSeconds(reclamationSeconds),
    fServerMediaSessions(HashTable::create(STRING_HASH_KEYS)),
    fClientConnections(HashTable::create(ONE_WORD_HASH_KEYS)),
    fClientSessions(HashTable::create(STRING_HASH_KEYS)) {
  ignoreSigPipeOnSocket(fServerSocket); // so that clients on the same host that are killed don&apos;t also kill us

  // Arrange to handle connections from others:
  env.taskScheduler().turnOnBackgroundReadHandling(fServerSocket, incomingConnectionHandler, this);
}<br></div></div>

<p><strong>In the <code>GenericMediaServer</code> constructor, to listen Server socket and I/O event on the socket handler is registered to the task scheduler. The handler is called when an I/O event occurs on the socket detected in the event loop. The registered event handler is <code>GenericMediaServer::incomingConnectionHandler()</code>.</strong></p>
<p><code>Medium</code> The constructor is defined as follows:</p>
<div class="ace"><div class="aceCode" data-config="{&quot;edit&quot;:false,&quot;lang&quot;:&quot;c_cpp&quot;,&quot;check&quot;:false,&quot;theme&quot;:&quot;monokai&quot;}">Medium::Medium(UsageEnvironment&amp; env)
    : fEnviron(env), fNextTask(NULL) {
  // First generate a name for the new medium:
  MediaLookupTable::ourMedia(env)-&gt;generateNewName(fMediumName, mediumNameMaxLen);
  env.setResultMsg(fMediumName);
  // Then add it to our table:
  MediaLookupTable::ourMedia(env)-&gt;addNew(this, fMediumName);
}<br></div></div>

<p>In <code>Medium</code> mainly by<code>MediaLookupTable</code> maintaining a medium name to <code>Medium</code> map
objects. <code>MediaLookupTable</code> can be regarded as <code>BasicHashTable</code> a value of
type <code>Medium</code> Patent object pointer, the class is defined as follows:</p>
<div class="ace"><div class="aceCode" data-config="{&quot;edit&quot;:false,&quot;lang&quot;:&quot;c_cpp&quot;,&quot;check&quot;:false,&quot;theme&quot;:&quot;monokai&quot;}">class MediaLookupTable {
public:
  static MediaLookupTable* ourMedia(UsageEnvironment&amp; env);
  HashTable const&amp; getTable() { return *fTable; }
protected:
  MediaLookupTable(UsageEnvironment&amp; env);
  virtual ~MediaLookupTable();
private:
  friend class Medium;
  Medium* lookup(char const* name) const;
  // Returns NULL if none already exists
  void addNew(Medium* medium, char* mediumName);
  void remove(char const* name);
  void generateNewName(char* mediumName, unsigned maxLen);
private:
  UsageEnvironment&amp; fEnv;
  HashTable* fTable;
  unsigned fNameGenerator;
};<br></div></div>

<p><code>MediaLookupTable</code> The actual quote from the <code>UsageEnvironment</code> holding:</p>
<div class="ace"><div class="aceCode" data-config="{&quot;edit&quot;:false,&quot;lang&quot;:&quot;c_cpp&quot;,&quot;check&quot;:false,&quot;theme&quot;:&quot;monokai&quot;}">_Tables* _Tables::getOurTables(UsageEnvironment&amp; env, Boolean createIfNotPresent) {
  if (env.liveMediaPriv == NULL &amp;&amp; createIfNotPresent) {
    env.liveMediaPriv = new _Tables(env);
  }
  return (_Tables*)(env.liveMediaPriv);
}
. . . . . .
MediaLookupTable* MediaLookupTable::ourMedia(UsageEnvironment&amp; env) {
  _Tables* ourTables = _Tables::getOurTables(env);
  if (ourTables-&gt;mediaTable == NULL) {
    // Create a new table to record the media that are to be created in
    // this environment:
    ourTables-&gt;mediaTable = new MediaLookupTable(env);
  }
  return ourTables-&gt;mediaTable;
}
. . . . . .
void MediaLookupTable::generateNewName(char* mediumName,
                       unsigned /*maxLen*/) {
  // We should really use snprintf() here, but not all systems have it
  sprintf(mediumName, &quot;liveMedia%d&quot;, fNameGenerator++);
}
MediaLookupTable::MediaLookupTable(UsageEnvironment&amp; env)
  : fEnv(env), fTable(HashTable::create(STRING_HASH_KEYS)), fNameGenerator(0) {
}<br></div></div>

<p>medium name in the <code>Medium</code> distribution construction process, created <code>Medium</code> at
this time are added <code>MediaLookupTable</code> in:</p>
<div class="ace"><div class="aceCode" data-config="{&quot;edit&quot;:false,&quot;lang&quot;:&quot;c_cpp&quot;,&quot;check&quot;:false,&quot;theme&quot;:&quot;monokai&quot;}">void MediaLookupTable::addNew(Medium* medium, char* mediumName) {
  fTable-&gt;Add(mediumName, (void*)medium);
}
. . . . . .
void MediaLookupTable::generateNewName(char* mediumName,
                       unsigned /*maxLen*/) {
  // We should really use snprintf() here, but not all systems have it
  sprintf(mediumName, &quot;liveMedia%d&quot;, fNameGenerator++);
}<br></div></div>

<h2 id="server-socket-creation-and-connection-establishment"><a name="server-socket-creation-and-connection-establishment" class="anchor-navigation-ex-anchor" href="#server-socket-creation-and-connection-establishment"><i class="fa fa-link" aria-hidden="true"></i></a>1.1. Server socket creation and connection establishment</h2>
<p>In <code>DynamicRTSPServer</code> the <code>createNew()</code> created <code>DynamicRTSPServer</code> before the object
will first by <code>setUpOurSocket()</code> creating a socket, <code>setUpOurSocket()</code>
is <code>GenericMediaServer</code> a static function, which is defined as:</p>
<div class="ace"><div class="aceCode" data-config="{&quot;edit&quot;:false,&quot;lang&quot;:&quot;c_cpp&quot;,&quot;check&quot;:false,&quot;theme&quot;:&quot;monokai&quot;}">int GenericMediaServer::setUpOurSocket(UsageEnvironment&amp; env, Port&amp; ourPort) {
  int ourSocket = -1;

  do {
    // The following statement is enabled by default.
    // Don&apos;t disable it (by defining ALLOW_SERVER_PORT_REUSE) unless you know what you&apos;re doing.
#if !defined(ALLOW_SERVER_PORT_REUSE) &amp;&amp; !defined(ALLOW_RTSP_SERVER_PORT_REUSE)
    // ALLOW_RTSP_SERVER_PORT_REUSE is for backwards-compatibility #####
    NoReuse dummy(env); // Don&apos;t use this socket if there&apos;s already a local server using it
#endif

    ourSocket = setupStreamSocket(env, ourPort);
    if (ourSocket &lt; 0) break;

    // Make sure we have a big send buffer:
    if (!increaseSendBufferTo(env, ourSocket, 50*1024)) break;

    // Allow multiple simultaneous connections:
    if (listen(ourSocket, LISTEN_BACKLOG_SIZE) &lt; 0) {
      env.setResultErrMsg(&quot;listen() failed: &quot;);
      break;
    }

    if (ourPort.num() == 0) {
      // bind() will have chosen a port for us; return it also:
      if (!getSourcePort(env, ourSocket, ourPort)) break;
    }

    return ourSocket;
  } while (0);

  if (ourSocket != -1) ::closeSocket(ourSocket);
  return -1;
}<br></div></div>

<p><code>GenericMediaServer::setUpOurSocket()</code> That is, mainly,
by <code>setupStreamSocket()</code> creating a function a TCP socket, the socket&apos;s send buffer
increases, and listen to the socket.</p>
<p><code>setupStreamSocket()</code> The function is defined in the groupsock module:</p>
<div class="ace"><div class="aceCode" data-config="{&quot;edit&quot;:false,&quot;lang&quot;:&quot;c_cpp&quot;,&quot;check&quot;:false,&quot;theme&quot;:&quot;monokai&quot;}">_groupsockPriv* groupsockPriv(UsageEnvironment&amp; env) {
  if (env.groupsockPriv == NULL) { // We need to create it
    _groupsockPriv* result = new _groupsockPriv;
    result-&gt;socketTable = NULL;
    result-&gt;reuseFlag = 1; // default value =&gt; allow reuse of socket numbers
    env.groupsockPriv = result;
  }
  return (_groupsockPriv*)(env.groupsockPriv);
}
void reclaimGroupsockPriv(UsageEnvironment&amp; env) {
  _groupsockPriv* priv = (_groupsockPriv*)(env.groupsockPriv);
  if (priv-&gt;socketTable == NULL &amp;&amp; priv-&gt;reuseFlag == 1/*default value*/) {
    // We can delete the structure (to save space); it will get created again, if needed:
    delete priv;
    env.groupsockPriv = NULL;
  }
}
static int createSocket(int type) {
  // Call &quot;socket()&quot; to create a (IPv4) socket of the specified type.
  // But also set it to have the &apos;close on exec&apos; property (if we can)
  int sock;
#ifdef SOCK_CLOEXEC
  sock = socket(AF_INET, type|SOCK_CLOEXEC, 0);
  if (sock != -1 || errno != EINVAL) return sock;
  // An &quot;errno&quot; of EINVAL likely means that the system wasn&apos;t happy with the SOCK_CLOEXEC; fall through and try again without it:
#endif
  sock = socket(AF_INET, type, 0);
#ifdef FD_CLOEXEC
  if (sock != -1) fcntl(sock, F_SETFD, FD_CLOEXEC);
#endif
  return sock;
}
. . . . . .
int setupStreamSocket(UsageEnvironment&amp; env,
                      Port port, Boolean makeNonBlocking) {
  if (!initializeWinsockIfNecessary()) {
    socketErr(env, &quot;Failed to initialize &apos;winsock&apos;: &quot;);
    return -1;
  }
  int newSocket = createSocket(SOCK_STREAM);
  if (newSocket &lt; 0) {
    socketErr(env, &quot;unable to create stream socket: &quot;);
    return newSocket;
  }
  int reuseFlag = groupsockPriv(env)-&gt;reuseFlag;
  reclaimGroupsockPriv(env);
  if (setsockopt(newSocket, SOL_SOCKET, SO_REUSEADDR,
         (const char*)&amp;reuseFlag, sizeof reuseFlag) &lt; 0) {
    socketErr(env, &quot;setsockopt(SO_REUSEADDR) error: &quot;);
    closeSocket(newSocket);
    return -1;
  }
  // SO_REUSEPORT doesn&apos;t really make sense for TCP sockets, so we
  // normally don&apos;t set them.  However, if you really want to do this
  // #define REUSE_FOR_TCP
#ifdef REUSE_FOR_TCP
#if defined(__WIN32__) || defined(_WIN32)
  // Windoze doesn&apos;t properly handle SO_REUSEPORT
#else
#ifdef SO_REUSEPORT
  if (setsockopt(newSocket, SOL_SOCKET, SO_REUSEPORT,
         (const char*)&amp;reuseFlag, sizeof reuseFlag) &lt; 0) {
    socketErr(env, &quot;setsockopt(SO_REUSEPORT) error: &quot;);
    closeSocket(newSocket);
    return -1;
  }
#endif
#endif
#endif
  // Note: Windoze requires binding, even if the port number is 0
#if defined(__WIN32__) || defined(_WIN32)
#else
  if (port.num() != 0 || ReceivingInterfaceAddr != INADDR_ANY) {
#endif
    MAKE_SOCKADDR_IN(name, ReceivingInterfaceAddr, port.num());
    if (bind(newSocket, (struct sockaddr*)&amp;name, sizeof name) != 0) {
      char tmpBuffer[100];
      sprintf(tmpBuffer, &quot;bind() error (port number: %d): &quot;,
          ntohs(port.num()));
      socketErr(env, tmpBuffer);
      closeSocket(newSocket);
      return -1;
    }
#if defined(__WIN32__) || defined(_WIN32)
#else
  }
#endif
  if (makeNonBlocking) {
    if (!makeSocketNonBlocking(newSocket)) {
      socketErr(env, &quot;failed to make non-blocking: &quot;);
      closeSocket(newSocket);
      return -1;
    }
  }
  return newSocket;
}<br></div></div>

<p>Here is basically to create a TCP socket, set the RESUE option for the socket,
bind the socket to the target port, and set the socket to be non-blocking as
needed.</p>
<p>Then, in live555, how to start listening for I/O events on the server socket and
handling these events.</p>
<p>We see that in <code>GenericMediaServer</code> the constructor for receiving client-initiated
server socket connection, and I/O event handler on the socket, is registered
to the task scheduler. This handler is called when a client initiates a
connection to the &quot;LIVE555 Media Server&quot;. The event handler
is <code>GenericMediaServer::incomingConnectionHandler()</code>, the related functions are
declared as:</p>
<div class="ace"><div class="aceCode" data-config="{&quot;edit&quot;:false,&quot;lang&quot;:&quot;c_cpp&quot;,&quot;check&quot;:false,&quot;theme&quot;:&quot;monokai&quot;}">class GenericMediaServer: public Medium {
. . . . . .
protected:
. . . . . .
  static void incomingConnectionHandler(void*, int /*mask*/);
  void incomingConnectionHandler();
  void incomingConnectionHandlerOnSocket(int serverSocket);
. . . . . .
protected:
  virtual ClientConnection* createNewClientConnection(int clientSocket, struct sockaddr_in clientAddr) = 0;<br></div></div>


<p><code>GenericMediaServer::incomingConnectionHandler()</code> is a static
function, <code>incomingConnectionHandler()</code> and
<code>incomingConnectionHandlerOnSocket(int serverSocket)</code> For non-virtual functions,
they are defined as:</p>
<div class="ace"><div class="aceCode" data-config="{&quot;edit&quot;:false,&quot;lang&quot;:&quot;c_cpp&quot;,&quot;check&quot;:false,&quot;theme&quot;:&quot;monokai&quot;}">void GenericMediaServer::incomingConnectionHandler(void* instance, int /*mask*/) {
  GenericMediaServer* server = (GenericMediaServer*)instance;
  server-&gt;incomingConnectionHandler();
}
void GenericMediaServer::incomingConnectionHandler() {
  incomingConnectionHandlerOnSocket(fServerSocket);
}
void GenericMediaServer::incomingConnectionHandlerOnSocket(int serverSocket) {
  struct sockaddr_in clientAddr;
  SOCKLEN_T clientAddrLen = sizeof clientAddr;
  int clientSocket = accept(serverSocket, (struct sockaddr*)&amp;clientAddr, &amp;clientAddrLen);
  if (clientSocket &lt; 0) {
    int err = envir().getErrno();
    if (err != EWOULDBLOCK) {
      envir().setResultErrMsg(&quot;accept() failed: &quot;);
    }
    return;
  }
  ignoreSigPipeOnSocket(clientSocket); // so that clients on the same host that are killed don&apos;t also kill us
  makeSocketNonBlocking(clientSocket);
  increaseSendBufferTo(envir(), clientSocket, 50*1024);

#ifdef DEBUG
  envir() &lt;&lt; &quot;accept()ed connection from &quot; &lt;&lt; AddressString(clientAddr).val() &lt;&lt; &quot;\n&quot;;
#endif

  // Create a new object for handling this connection:
  (void)createNewClientConnection(clientSocket, clientAddr);
}<br></div></div>

<p>It can be seen that when a client-initiated connection request is found on the
monitored server socket, the processing is generally:</p>
<ol>
<li><p>By <code>accept()</code> obtaining a new socket connection established.</p>
</li>
<li><p>Set the option for the new socket to make it a non-blocking socket and
increase the send buffer for that socket. Take a look at these functions
that set the socket option in live555, which are defined in the groupsock
module:</p>
</li>
</ol>
<div class="ace"><div class="aceCode" data-config="{&quot;edit&quot;:false,&quot;lang&quot;:&quot;c_cpp&quot;,&quot;check&quot;:false,&quot;theme&quot;:&quot;monokai&quot;}">Boolean makeSocketNonBlocking(int sock) {
    . . . . . .
      int curFlags = fcntl(sock, F_GETFL, 0);
      return fcntl(sock, F_SETFL, curFlags|O_NONBLOCK) &gt;= 0;
    #endif
    }
    . . . . . .
    void ignoreSigPipeOnSocket(int socketNum) {
    . . . . . .
      signal(SIGPIPE, SIG_IGN);
      #endif
      #endif
    }
    static unsigned getBufferSize(UsageEnvironment&amp; env, int bufOptName,
                      int socket) {
      unsigned curSize;
      SOCKLEN_T sizeSize = sizeof curSize;
      if (getsockopt(socket, SOL_SOCKET, bufOptName,
             (char*)&amp;curSize, &amp;sizeSize) &lt; 0) {
        socketErr(env, &quot;getBufferSize() error: &quot;);
        return 0;
      }
      return curSize;
    }
    . . . . . .
    static unsigned increaseBufferTo(UsageEnvironment&amp; env, int bufOptName,
                     int socket, unsigned requestedSize) {
      // First, get the current buffer size.  If it&apos;s already at least
      // as big as what we&apos;re requesting, do nothing.
      unsigned curSize = getBufferSize(env, bufOptName, socket);
      // Next, try to increase the buffer to the requested size,
      // or to some smaller size, if that&apos;s not possible:
      while (requestedSize &gt; curSize) {
        SOCKLEN_T sizeSize = sizeof requestedSize;
        if (setsockopt(socket, SOL_SOCKET, bufOptName,
               (char*)&amp;requestedSize, sizeSize) &gt;= 0) {
          // success
          return requestedSize;
        }
        requestedSize = (requestedSize+curSize)/2;
      }
      return getBufferSize(env, bufOptName, socket);
    }
    unsigned increaseSendBufferTo(UsageEnvironment&amp; env,
                      int socket, unsigned requestedSize) {
      return increaseBufferTo(env, SO_SNDBUF, socket, requestedSize);
    }<br></div></div>


<ol>
<li>By <code>createNewClientConnection()</code>, create a new client
connection <code>ClientConnection</code>. <code>createNewClientConnection()</code> is a pure virtual
function, its implementation will be realized in the class hierarchy of the
function of the lowest class in the class inheritance hierarchy, for 
<code>DynamicRTSPServer -&gt; RTSPServerSupportingHTTPStreaming -&gt; RTSPServer -&gt; GenericMediaServer</code> this inheritance hierarchy, from the <code>DynamicRTSPServer</code> class began, looking up
step by step, you can We found that <code>createNewClientConnection()</code> implementation of the function in the <code>RTSPServerSupportingHTTPStreaming</code> class.</li>
</ol>
<p><code>RTSPServerSupportingHTTPStreaming</code> The 
<code>createNewClientConnection()</code> function of the class is defined as follows:</p>
<div class="ace"><div class="aceCode" data-config="{&quot;edit&quot;:false,&quot;lang&quot;:&quot;c_cpp&quot;,&quot;check&quot;:false,&quot;theme&quot;:&quot;monokai&quot;}">GenericMediaServer::ClientConnection*
RTSPServerSupportingHTTPStreaming::createNewClientConnection(int clientSocket, struct sockaddr_in clientAddr) {
  return new RTSPClientConnectionSupportingHTTPStreaming(*this, clientSocket, clientAddr);
}
RTSPServerSupportingHTTPStreaming::RTSPClientConnectionSupportingHTTPStreaming
::RTSPClientConnectionSupportingHTTPStreaming(RTSPServer&amp; ourServer, int clientSocket, struct sockaddr_in clientAddr)
  : RTSPClientConnection(ourServer, clientSocket, clientAddr),
    fClientSessionId(0), fStreamSource(NULL), fPlaylistSource(NULL), fTCPSink(NULL) {
}<br></div></div>

<p>Here simply create a <code>RTSPClientConnectionSupportingHTTPStreaming</code> class object. In
live555, washed with <code>GenericMediaServer</code> interior
class <code>GenericMediaServer::ClientConnection</code> represents a client connection. For
the &quot;LIVE555 Media Server&quot;, the inheritance hierarchy of this class is shown in
the following figure:</p>
<p>     <a href="media/f2922878061449b7a7d828ccb9bc7068.png" rel="grouped" title="https://www.wolfcstech.com/images/1315506-25767662578513fe.png" target="_self" class="fancybox">
       <img src="media/f2922878061449b7a7d828ccb9bc7068.png" alt="https://www.wolfcstech.com/images/1315506-25767662578513fe.png">
     </a></p>
<p><code>RTSPClientConnectionSupportingHTTPStreaming</code> Class object constructor call parent
class <code>RTSPServer::RTSPClientConnection</code> constructor, which is implemented as:</p>
<div class="ace"><div class="aceCode" data-config="{&quot;edit&quot;:false,&quot;lang&quot;:&quot;c_cpp&quot;,&quot;check&quot;:false,&quot;theme&quot;:&quot;monokai&quot;}">GenericMediaServer::ClientConnection
::ClientConnection(GenericMediaServer&amp; ourServer, int clientSocket, struct sockaddr_in clientAddr)
  : fOurServer(ourServer), fOurSocket(clientSocket), fClientAddr(clientAddr) {
  // Add ourself to our &apos;client connections&apos; table:
  fOurServer.fClientConnections-&gt;Add((char const*)this, this);

  // Arrange to handle incoming requests:
  resetRequestBuffer();
  envir().taskScheduler()
    .setBackgroundHandling(fOurSocket, SOCKET_READABLE|SOCKET_EXCEPTION, incomingRequestHandler, this);
}<br></div></div>

<p><code>RTSPServer::RTSPClientConnection</code> Constructor continues to call its parent
class <code>GenericMediaServer::ClientConnection</code> constructor:</p>
<div class="ace"><div class="aceCode" data-config="{&quot;edit&quot;:false,&quot;lang&quot;:&quot;c_cpp&quot;,&quot;check&quot;:false,&quot;theme&quot;:&quot;monokai&quot;}">void GenericMediaServer::ClientConnection::incomingRequestHandler(void* instance, int /*mask*/) {
  ClientConnection* connection = (ClientConnection*)instance;
  connection-&gt;incomingRequestHandler();
}
void GenericMediaServer::ClientConnection::incomingRequestHandler() {
  struct sockaddr_in dummy; // &apos;from&apos; address, meaningless in this case

  int bytesRead = readSocket(envir(), fOurSocket, &amp;fRequestBuffer[fRequestBytesAlreadySeen], fRequestBufferBytesLeft, dummy);
  handleRequestBytes(bytesRead);
}<br></div></div>

<p>In live555, it is <code>GenericMediaServer</code> used to perform common media server-related
management, including managing all client
connections. <code>GenericMediaServer::ClientConnection</code> Constructor added adds its
own <code>GenericMediaServer</code> hash table <code>fClientConnections</code> in. More importantly, the
client-attached socket and the I/O event handler on the socket are registered to
the task scheduler, where the I/O event handler is</p>
<p><code>GenericMediaServer::ClientConnection::incomingRequestHandler()</code> function.</p>
<p>In other words, the interaction with the client in &quot;LIVE555 Media Server&quot; will
be
<code>GenericMediaServer::ClientConnection::incomingRequestHandler()</code> The function is
completed, this function is defined as follows:</p>
<div class="ace"><div class="aceCode" data-config="{&quot;edit&quot;:false,&quot;lang&quot;:&quot;c_cpp&quot;,&quot;check&quot;:false,&quot;theme&quot;:&quot;monokai&quot;}">void GenericMediaServer::ClientConnection::incomingRequestHandler(void* instance, int /*mask*/) {
  ClientConnection* connection = (ClientConnection*)instance;
  connection-&gt;incomingRequestHandler();
}
void GenericMediaServer::ClientConnection::incomingRequestHandler() {
  struct sockaddr_in dummy; // &apos;from&apos; address, meaningless in this case

  int bytesRead = readSocket(envir(), fOurSocket, &amp;fRequestBuffer[fRequestBytesAlreadySeen], fRequestBufferBytesLeft, dummy);
  handleRequestBytes(bytesRead);
}<br></div></div>

<p>In <code>GenericMediaServer::ClientConnection</code> the <code>incomingRequestHandler()</code> middle, to
read data from the client socket connection, and then
calls <code>handleRequestBytes()</code> the function for further processing.</p>
<p>Reading data from the operation module groupsock <code>readSocket()</code> completed:</p>
<div class="ace"><div class="aceCode" data-config="{&quot;edit&quot;:false,&quot;lang&quot;:&quot;c_cpp&quot;,&quot;check&quot;:false,&quot;theme&quot;:&quot;monokai&quot;}">int readSocket(UsageEnvironment&amp; env,
           int socket, unsigned char* buffer, unsigned bufferSize,
           struct sockaddr_in&amp; fromAddress) {
  SOCKLEN_T addressSize = sizeof fromAddress;
  int bytesRead = recvfrom(socket, (char*)buffer, bufferSize, 0,
               (struct sockaddr*)&amp;fromAddress,
               &amp;addressSize);
  if (bytesRead &lt; 0) {
    //##### HACK to work around bugs in Linux and Windows:
    int err = env.getErrno();
    if (err == 111 /*ECONNREFUSED (Linux)*/
. . . . . .
    || err == EAGAIN
#endif
    || err == 113 /*EHOSTUNREACH (Linux)*/) { // Why does Linux return this for datagram sock?
      fromAddress.sin_addr.s_addr = 0;
      return 0;
    }
    //##### END HACK
    socketErr(env, &quot;recvfrom() error: &quot;);
  } else if (bytesRead == 0) {
    // &quot;recvfrom()&quot; on a stream socket can return 0 if the remote end has closed the connection.  Treat this as an error:
    return -1;
  }
  return bytesRead;
}<br></div></div>

<p>Here by <code>recvfrom()</code> reading data from the socket functions.</p>
<p><code>GenericMediaServer::ClientConnection</code> In the process, the functions that handle
client requests are declared as follows:</p>
<div class="ace"><div class="aceCode" data-config="{&quot;edit&quot;:false,&quot;lang&quot;:&quot;c_cpp&quot;,&quot;check&quot;:false,&quot;theme&quot;:&quot;monokai&quot;}">static void incomingRequestHandler(void*, int /*mask*/);
void incomingRequestHandler();
virtual void handleRequestBytes(int newBytesRead) = 0;<br></div></div>


<p><code>handleRequestBytes()</code> For pure virtual functions, it needs to be implemented by subclasses. for
<code>RTSPServerSupportingHTTPStreaming::RTSPClientConnectionSupportingHTTPStreaming -&gt; RTSPServer::RTSPClientConnection -&gt; GenericMediaServer::ClientConnection</code>. The inheritance hierarchy, implementation of the function is actually
located in <code>RTSPServer::RTSPClientConnection</code>.</p>
<p>The request received from the client will be <code>RTSPServer::RTSPClientConnection::handleRequestBytes()</code> deal with.</p>
<p><a href="https://www.wolfcstech.com/about/donate.html" target="_blank">Reward</a></p>
<p>Done.</p>
<h2 id="live555-source-code-analysis-series"><a name="live555-source-code-analysis-series" class="anchor-navigation-ex-anchor" href="#live555-source-code-analysis-series"><i class="fa fa-link" aria-hidden="true"></i></a>1.2. Live555 source code analysis series</h2>
<ol>
<li><a href="Live555%20-%20Live555%20source%20code%20analysis_introduction.html">Live555 Source code analysis: Introduction </a></li>
<li><a href="Live555%20-%20Live555%20source%20code%20analysis_infrastructure.html">live555 Source code analysis: Infrastructure </a></li>
<li><a href="https://www.wolfcstech.com/2017/08/31/live555_src_analysis_mediaserver/" target="_blank">live555 Source code analysis: MediaSever </a></li>
<li><a href="Live555%20-%20Wireshark%20capture%20packet%20analysis%20RTSP_RTP_RTCP%20basic%20working%20process.html">Wireshark capture packet analysis RTSP/RTP/RTCP Basic working process </a></li>
<li><a href="Live555%20-%20Live555%20source%20code%20analysis_rtspserver.html">live555 Source code analysis: RTSPServer </a></li>
<li><a href="Live555%20-%20Live555%20source%20code%20analysis_describe%20processing.html">live555 Source code analysis: DESCRIBE processing </a></li>
<li><a href="Live555%20-%20Live555%20source%20code%20analysis_setup%20processing.html">live555 Source code analysis: SETUP processing </a></li>
<li><a href="Live555%20-%20Live555%20source%20code%20analysis_play%20processing.html">live555 Source code analysis :PLAY processing </a></li>
<li><a href="Live555%20-%20Live555%20source%20code%20analysis_RTSPServer%20component%20structure.html">live555 Source code analysis: RTSPServer component structure </a></li>
<li><a href="Live555%20-%20Live555%20source%20code%20analysis_servermediasession.html">live555 Source code analysis: </a></li>
<li><a href="Live555%20-%20Live555%20source%20code%20analysis_subsession%20SDP%20line%20generation.html">ServerMediaSession live555 Source code analysis: sub-session SDP line generation </a></li>
<li><a href="Live555%20-%20Live555%20source%20code%20analysis_Subsession%20SETUP.html">live555 Source code analysis: sub-session SETUP </a></li>
<li><a href="Live555%20-%20Live555%20source%20code%20analysis_play%20start.html">live555 Source code analysis: play start</a></li>
</ol>

                                
                                </section>
                            
    </div>
    <div class="search-results">
        <div class="has-results">
            
            <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
            <ul class="search-results-list"></ul>
            
        </div>
        <div class="no-results">
            
            <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
            
        </div>
    </div>
</div>

                        </div>
                    </div>
                
            </div>

            
                
                <a href="Live555 - Live555 source code analysis_infrastructure.html" class="navigation navigation-prev " aria-label="Previous page: Live555 - Live555 source code analysis_infrastructure">
                    <i class="fa fa-angle-left"></i>
                </a>
                
                
                <a href="Live555 - Wireshark capture packet analysis RTSP_RTP_RTCP basic working process.html" class="navigation navigation-next " aria-label="Next page: Live555 - Wireshark capture packet analysis RTSP_RTP_RTCP basic working process">
                    <i class="fa fa-angle-right"></i>
                </a>
                
            
        
    </div>

    <script>
        var gitbook = gitbook || [];
        gitbook.push(function() {
            gitbook.page.hasChanged({"page":{"title":"Live555 - Live555 source code analysis_mediaserver","level":"1.10.3","depth":2,"next":{"title":"Live555 - Wireshark capture packet analysis RTSP_RTP_RTCP basic working process","level":"1.10.4","depth":2,"path":"Live555 - Wireshark capture packet analysis RTSP_RTP_RTCP basic working process.md","ref":"Live555 - Wireshark capture packet analysis RTSP_RTP_RTCP basic working process.md","articles":[]},"previous":{"title":"Live555 - Live555 source code analysis_infrastructure","level":"1.10.2","depth":2,"path":"Live555 - Live555 source code analysis_infrastructure.md","ref":"Live555 - Live555 source code analysis_infrastructure.md","articles":[]},"dir":"ltr"},"config":{"plugins":["include-html","fancybox","anchor-navigation-ex-toc","ace","-lunr","-search","search-plus","hide-published-with","splitter","expandable-chapters-interactive","wide-page"],"root":"./docs","styles":{"website":"styles/website.css"},"pluginsConfig":{"fancybox":{"helpers":{"buttons":{}}},"ace":{},"splitter":{},"wide-page":{},"anchor-navigation-ex-toc":{"showLevel":true,"associatedWithSummary":true,"mode":"float","printLog":false,"multipleH1":true,"float":{"showLevelIcon":false,"level1Icon":"","level2Icon":"","level3Icon":""},"pageTop":{"showLevelIcon":false,"level1Icon":"","level2Icon":"","level3Icon":""}},"hide-published-with":{},"include-html":{},"fontsettings":{"theme":"white","family":"sans","size":2},"highlight":{},"expandable-chapters-interactive":{},"sharing":{"facebook":true,"twitter":true,"google":false,"weibo":false,"instapaper":false,"vk":false,"all":["facebook","google","twitter","weibo","instapaper"]},"theme-default":{"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"showLevel":false},"expandable-chapters":{},"search-plus":{}},"theme":"default","pdf":{"pageNumbers":true,"fontSize":12,"fontFamily":"Arial","paperSize":"a4","chapterMark":"pagebreak","pageBreaksBefore":"/","margin":{"right":62,"left":62,"top":56,"bottom":56}},"structure":{"langs":"LANGS.md","readme":"README.md","glossary":"GLOSSARY.md","summary":"SUMMARY.md"},"variables":{},"gitbook":"*"},"file":{"path":"Live555 - Live555 source code analysis_mediaserver.md","mtime":"2019-03-05T06:15:29.917Z","type":"markdown"},"gitbook":{"version":"3.3.6","time":"2023-12-10T09:35:29.798Z"},"basePath":".","book":{"language":""}});
        });
    </script>
</div>

        
    <script src="gitbook/gitbook.js"></script>
    <script src="gitbook/theme.js"></script>
    
        
        <script src="gitbook/gitbook-plugin-fancybox/jquery.min.js"></script>
        
    
        
        <script src="gitbook/gitbook-plugin-fancybox/jquery.mousewheel.pack.js"></script>
        
    
        
        <script src="gitbook/gitbook-plugin-fancybox/jquery.fancybox.pack.js"></script>
        
    
        
        <script src="gitbook/gitbook-plugin-fancybox/jquery.fancybox-buttons.js"></script>
        
    
        
        <script src="gitbook/gitbook-plugin-fancybox/plugin.js"></script>
        
    
        
        <script src="gitbook/gitbook-plugin-ace/ace/ace.js"></script>
        
    
        
        <script src="gitbook/gitbook-plugin-ace/ace.js"></script>
        
    
        
        <script src="gitbook/gitbook-plugin-search-plus/jquery.mark.min.js"></script>
        
    
        
        <script src="gitbook/gitbook-plugin-search-plus/search.js"></script>
        
    
        
        <script src="gitbook/gitbook-plugin-hide-published-with/plugin.js"></script>
        
    
        
        <script src="gitbook/gitbook-plugin-splitter/splitter.js"></script>
        
    
        
        <script src="gitbook/gitbook-plugin-expandable-chapters-interactive/expandable-chapters.js"></script>
        
    
        
        <script src="gitbook/@gitbook-ng/gitbook-plugin-sharing/buttons.js"></script>
        
    
        
        <script src="gitbook/gitbook-plugin-fontsettings/fontsettings.js"></script>
        
    

    </body>
</html>

