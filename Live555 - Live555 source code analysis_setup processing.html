
<!DOCTYPE HTML>
<html lang="" >
    <head>
        <meta charset="UTF-8">
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <title>Live555 - Live555 source code analysis_setup processing Â· GitBook</title>
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="description" content="">
        <meta name="generator" content="@gitbook-ng/gitbook 3.3.6">
        
        
        
    
    <link rel="stylesheet" href="gitbook/style.css">

    
            
                
                <link rel="stylesheet" href="gitbook/gitbook-plugin-fancybox/jquery.fancybox.css">
                
            
                
                <link rel="stylesheet" href="gitbook/gitbook-plugin-fancybox/jquery.fancybox-buttons.css">
                
            
                
                <link rel="stylesheet" href="gitbook/gitbook-plugin-anchor-navigation-ex-toc/style/plugin.css">
                
            
                
                <link rel="stylesheet" href="gitbook/gitbook-plugin-ace/ace.css">
                
            
                
                <link rel="stylesheet" href="gitbook/gitbook-plugin-search-plus/search.css">
                
            
                
                <link rel="stylesheet" href="gitbook/gitbook-plugin-splitter/splitter.css">
                
            
                
                <link rel="stylesheet" href="gitbook/gitbook-plugin-expandable-chapters-interactive/expandable-chapters.css">
                
            
                
                <link rel="stylesheet" href="gitbook/gitbook-plugin-wide-page/wide.css">
                
            
                
                <link rel="stylesheet" href="gitbook/gitbook-plugin-highlight/website.css">
                
            
                
                <link rel="stylesheet" href="gitbook/gitbook-plugin-fontsettings/website.css">
                
            
        

    

    
        
        <link rel="stylesheet" href="styles/website.css">
        
    

        
    
    
    <meta name="HandheldFriendly" content="true"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="apple-touch-icon-precomposed" sizes="152x152" href="gitbook/images/apple-touch-icon-precomposed-152.png">
    <link rel="shortcut icon" href="gitbook/images/favicon.ico" type="image/x-icon">

    
    <link rel="next" href="Live555 - Live555 source code analysis_play processing.html" />
    
    
    <link rel="prev" href="Live555 - Live555 source code analysis_describe processing.html" />
    

    </head>
    <body>
        
<div class="book">
    <div class="book-summary">
        
            
<div id="book-search-input" role="search">
    <input type="text" placeholder="Type to search" />
</div>

            
                <nav role="navigation">
                


<ul class="summary">
    
    

    

    
        
        
    
        <li class="chapter " data-level="1.1" data-path="./">
            
                <a href="./">
            
                    
                    Introduction
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2" >
            
                <span>
            
                    
                    Graphical Android
            
                </span>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.2.1" data-path="Graphical Android - Zygote, System Server startup analysis.html">
            
                <a href="Graphical Android - Zygote, System Server startup analysis.html">
            
                    
                    Graphical Android - Zygote, System Server startup analysis
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.3" >
            
                <span>
            
                    
                    Android Permissions
            
                </span>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.3.1" data-path="Android Permissions - Android Runtime Permission.html">
            
                <a href="Android Permissions - Android Runtime Permission.html">
            
                    
                    Android Permissions - Android Runtime Permission
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.2" data-path="Android Permissions - Android grantRuntimePermission Detailed.html">
            
                <a href="Android Permissions - Android grantRuntimePermission Detailed.html">
            
                    
                    Android Permissions - Android grantRuntimePermission Detailed
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.3" data-path="Android Permissions - Android GrantPermissionsActivity Detailed.html">
            
                <a href="Android Permissions - Android GrantPermissionsActivity Detailed.html">
            
                    
                    Android Permissions - Android GrantPermissionsActivity Detailed
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.4" data-path="Android Permissions - AppOps control for Normal permission.html">
            
                <a href="Android Permissions - AppOps control for Normal permission.html">
            
                    
                    Android Permissions - AppOps control for Normal permission
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.5" data-path="Android Permissions - Android native permission control process.html">
            
                <a href="Android Permissions - Android native permission control process.html">
            
                    
                    Android Permissions - Android native permission control process
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.6" data-path="Android Permissions - The difference between setUidMode and setMode in AppOps.html">
            
                <a href="Android Permissions - The difference between setUidMode and setMode in AppOps.html">
            
                    
                    Android Permissions - The difference between setUidMode and setMode in AppOps
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.7" data-path="Android Permissions - Application permissions before android M and application permissions after M.html">
            
                <a href="Android Permissions - Application permissions before android M and application permissions after M.html">
            
                    
                    Android Permissions - Application permissions before android M and application permissions after M
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.8" data-path="Android Permissions - Provider permissions detailed.html">
            
                <a href="Android Permissions - Provider permissions detailed.html">
            
                    
                    Android Permissions - Provider permissions detailed
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.4" >
            
                <span>
            
                    
                    Android OTA
            
                </span>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.4.1" data-path="Android OTA - Android OTA upgrade principle and process analysis 1.html">
            
                <a href="Android OTA - Android OTA upgrade principle and process analysis 1.html">
            
                    
                    Android OTA - Android OTA upgrade principle and process analysis 1
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.2" data-path="Android OTA - Android OTA upgrade principle and process analysis 2.html">
            
                <a href="Android OTA - Android OTA upgrade principle and process analysis 2.html">
            
                    
                    Android OTA - Android OTA upgrade principle and process analysis 2
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.3" data-path="Android OTA - Android OTA upgrade principle and process analysis 3.html">
            
                <a href="Android OTA - Android OTA upgrade principle and process analysis 3.html">
            
                    
                    Android OTA - Android OTA upgrade principle and process analysis 3
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.4" data-path="Android OTA - Android OTA upgrade principle and process analysis 4.html">
            
                <a href="Android OTA - Android OTA upgrade principle and process analysis 4.html">
            
                    
                    Android OTA - Android OTA upgrade principle and process analysis 4
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.5" data-path="Android OTA - Android OTA upgrade principle and process analysis 5.html">
            
                <a href="Android OTA - Android OTA upgrade principle and process analysis 5.html">
            
                    
                    Android OTA - Android OTA upgrade principle and process analysis 5
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.6" data-path="Android OTA - Android OTA upgrade principle and process analysis 6.html">
            
                <a href="Android OTA - Android OTA upgrade principle and process analysis 6.html">
            
                    
                    Android OTA - Android OTA upgrade principle and process analysis 6
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.7" data-path="Android OTA - Android OTA upgrade principle and process analysis 7.html">
            
                <a href="Android OTA - Android OTA upgrade principle and process analysis 7.html">
            
                    
                    Android OTA - Android OTA upgrade principle and process analysis 7
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.8" data-path="Android OTA - Android OTA upgrade principle and process analysis 8.html">
            
                <a href="Android OTA - Android OTA upgrade principle and process analysis 8.html">
            
                    
                    Android OTA - Android OTA upgrade principle and process analysis 8
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.9" data-path="Android OTA - Android OTA upgrade principle and process analysis 9.html">
            
                <a href="Android OTA - Android OTA upgrade principle and process analysis 9.html">
            
                    
                    Android OTA - Android OTA upgrade principle and process analysis 9
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.5" >
            
                <span>
            
                    
                    Android Package Manager Service (PMS)
            
                </span>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.5.1" data-path="Android PMS - Explore the Android PMS service.html">
            
                <a href="Android PMS - Explore the Android PMS service.html">
            
                    
                    Android PMS - Explore the Android PMS service
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.2" data-path="Android PMS - Some rules of the PMS runtime.html">
            
                <a href="Android PMS - Some rules of the PMS runtime.html">
            
                    
                    Android PMS - Some rules of the PMS runtime
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.3" data-path="Android PMS - Android 6 PMS Analysis.html">
            
                <a href="Android PMS - Android 6 PMS Analysis.html">
            
                    
                    Android PMS - Android 6 PMS Analysis
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.4" data-path="Android PMS - Android 6 PMS analysis article 1.html">
            
                <a href="Android PMS - Android 6 PMS analysis article 1.html">
            
                    
                    Android PMS - Android 6 PMS analysis article 1
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.5" data-path="Android PMS - Android 6 PMS analysis article 2.html">
            
                <a href="Android PMS - Android 6 PMS analysis article 2.html">
            
                    
                    Android PMS - Android 6 PMS analysis article 2
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.6" data-path="Android PMS - Android 6 PMS analysis of the next article.html">
            
                <a href="Android PMS - Android 6 PMS analysis of the next article.html">
            
                    
                    Android PMS - Android 6 PMS analysis of the next article
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.7" data-path="Android PMS - Android 6 PMS install APK prelude.html">
            
                <a href="Android PMS - Android 6 PMS install APK prelude.html">
            
                    
                    Android PMS - Android 6 PMS install APK prelude
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.8" data-path="Android PMS - Android 6 PMS installation APK.html">
            
                <a href="Android PMS - Android 6 PMS installation APK.html">
            
                    
                    Android PMS - Android 6 PMS installation APK
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.9" data-path="Android PMS - Android 6 PMS installation APK next article.html">
            
                <a href="Android PMS - Android 6 PMS installation APK next article.html">
            
                    
                    Android PMS - Android 6 PMS installation APK next article
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.10" data-path="Android PMS - Android 6 PMS Uninstall APK.html">
            
                <a href="Android PMS - Android 6 PMS Uninstall APK.html">
            
                    
                    Android PMS - Android 6 PMS Uninstall APK
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.11" data-path="Android PMS - Android 6 PMS daemon installd.html">
            
                <a href="Android PMS - Android 6 PMS daemon installd.html">
            
                    
                    Android PMS - Android 6 PMS daemon installd
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.6" >
            
                <span>
            
                    
                    Android AOSP
            
                </span>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.6.1" data-path="Android AOSP - Debugging AOSP Platform code with Android Studio - Java Debugger.html">
            
                <a href="Android AOSP - Debugging AOSP Platform code with Android Studio - Java Debugger.html">
            
                    
                    Android AOSP - Debugging AOSP Platform code with Android Studio - Java Debugger
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.2" data-path="Android AOSP - Modify applications and rebuild emulator image effectively.html">
            
                <a href="Android AOSP - Modify applications and rebuild emulator image effectively.html">
            
                    
                    Android AOSP - Modify applications and rebuild emulator image effectively
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.7" >
            
                <span>
            
                    
                    Android General
            
                </span>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.7.1" data-path="Android General - Reliable connection to AIDL IPC Service in Android.html">
            
                <a href="Android General - Reliable connection to AIDL IPC Service in Android.html">
            
                    
                    Android General - Reliable connection to AIDL IPC Service in Android
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.8" >
            
                <span>
            
                    
                    Android Binder
            
                </span>
            

            
        </li>
    
        <li class="chapter " data-level="1.9" >
            
                <span>
            
                    
                    Android Activity Manager Service (AMS)
            
                </span>
            

            
        </li>
    
        <li class="chapter " data-level="1.10" >
            
                <span>
            
                    
                    Live555
            
                </span>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.10.1" data-path="Live555 - Live555 source code analysis_introduction.html">
            
                <a href="Live555 - Live555 source code analysis_introduction.html">
            
                    
                    Live555 - Live555 source code analysis_introduction
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.10.2" data-path="Live555 - Live555 source code analysis_infrastructure.html">
            
                <a href="Live555 - Live555 source code analysis_infrastructure.html">
            
                    
                    Live555 - Live555 source code analysis_infrastructure
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.10.3" data-path="Live555 - Live555 source code analysis_mediaserver.html">
            
                <a href="Live555 - Live555 source code analysis_mediaserver.html">
            
                    
                    Live555 - Live555 source code analysis_mediaserver
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.10.4" data-path="Live555 - Wireshark capture packet analysis RTSP_RTP_RTCP basic working process.html">
            
                <a href="Live555 - Wireshark capture packet analysis RTSP_RTP_RTCP basic working process.html">
            
                    
                    Live555 - Wireshark capture packet analysis RTSP_RTP_RTCP basic working process
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.10.5" data-path="Live555 - Live555 source code analysis_rtspserver.html">
            
                <a href="Live555 - Live555 source code analysis_rtspserver.html">
            
                    
                    Live555 - Live555 source code analysis_rtspserver
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.10.6" data-path="Live555 - Live555 source code analysis_describe processing.html">
            
                <a href="Live555 - Live555 source code analysis_describe processing.html">
            
                    
                    Live555 - Live555 source code analysis_describe processing
            
                </a>
            

            
        </li>
    
        <li class="chapter active" data-level="1.10.7" data-path="Live555 - Live555 source code analysis_setup processing.html">
            
                <a href="Live555 - Live555 source code analysis_setup processing.html">
            
                    
                    Live555 - Live555 source code analysis_setup processing
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.10.8" data-path="Live555 - Live555 source code analysis_play processing.html">
            
                <a href="Live555 - Live555 source code analysis_play processing.html">
            
                    
                    Live555 - Live555 source code analysis_play processing
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.10.9" data-path="Live555 - Live555 source code analysis_RTSPServer component structure.html">
            
                <a href="Live555 - Live555 source code analysis_RTSPServer component structure.html">
            
                    
                    Live555 - Live555 source code analysis_RTSPServer component structure
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.10.10" data-path="Live555 - Live555 source code analysis_servermediasession.html">
            
                <a href="Live555 - Live555 source code analysis_servermediasession.html">
            
                    
                    Live555 - Live555 source code analysis_servermediasession
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.10.11" data-path="Live555 - Live555 source code analysis_subsession SDP line generation.html">
            
                <a href="Live555 - Live555 source code analysis_subsession SDP line generation.html">
            
                    
                    Live555 - Live555 source code analysis_subsession SDP line generation
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.10.12" data-path="Live555 - Live555 source code analysis_Subsession SETUP.html">
            
                <a href="Live555 - Live555 source code analysis_Subsession SETUP.html">
            
                    
                    Live555 - Live555 source code analysis_Subsession SETUP
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.10.13" data-path="Live555 - Live555 source code analysis_play start.html">
            
                <a href="Live555 - Live555 source code analysis_play start.html">
            
                    
                    Live555 - Live555 source code analysis_play start
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.11" >
            
                <span>
            
                    
                    Flutter
            
                </span>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.11.1" data-path="Flutter Framework Analysis 1 - Overview and Window.html">
            
                <a href="Flutter Framework Analysis 1 - Overview and Window.html">
            
                    
                    Flutter Framework Analysis 1 - Overview and Window
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.11.2" data-path="Flutter Framework Analysis 2 - Initialization.html">
            
                <a href="Flutter Framework Analysis 2 - Initialization.html">
            
                    
                    Flutter Framework Analysis 2 - Initialization
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.11.3" data-path="Flutter Framework Analysis 3 - Widget, Element and RenderObject.html">
            
                <a href="Flutter Framework Analysis 3 - Widget, Element and RenderObject.html">
            
                    
                    Flutter Framework Analysis 3 - Widget, Element and RenderObject
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.11.4" data-path="Flutter Framework Analysis 4 - Flutter Framework Operation.html">
            
                <a href="Flutter Framework Analysis 4 - Flutter Framework Operation.html">
            
                    
                    Flutter Framework Analysis 4 - Flutter Framework Operation
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.11.5" data-path="Flutter Framework Analysis 5 - Animation.html">
            
                <a href="Flutter Framework Analysis 5 - Animation.html">
            
                    
                    Flutter Framework Analysis 5 - Animation
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.11.6" data-path="Flutter Framework Analysis 6 - Layout.html">
            
                <a href="Flutter Framework Analysis 6 - Layout.html">
            
                    
                    Flutter Framework Analysis 6 - Layout
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.11.7" data-path="Flutter Framework Analysis 7 - Drawing.html">
            
                <a href="Flutter Framework Analysis 7 - Drawing.html">
            
                    
                    Flutter Framework Analysis 7 - Drawing
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    

    
</ul>


                </nav>
            
        
    </div>

    <div class="book-body">
        
            <div class="body-inner">
                
                    

<div class="book-header" role="navigation">
    

    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href="." >Live555 - Live555 source code analysis_setup processing</a>
    </h1>
</div>




                    <div class="page-wrapper" tabindex="-1" role="main">
                        <div class="page-inner">
                            
<div class="search-plus" id="book-search-results">
    <div class="search-noresults">
    
                                <section class="normal markdown-section">
                                
                                <div id="anchor-navigation-ex-navbar"><i class="fa fa-anchor"></i><ul><li><span class="title-icon "></span><a href="#live555-source-code-analysis-setup-processing"><b>1. </b>Live555 Source Code Analysis: SETUP processing</a></li><ul><li><span class="title-icon "></span><a href="#live555-source-code-analysis-series"><b>1.1. </b>Live555 source code analysis series</a></li></ul></ul></div><a href="#live555-source-code-analysis-setup-processing" id="anchorNavigationExGoTop"><i class="fa fa-arrow-up"></i></a><h1 id="live555-source-code-analysis-setup-processing"><a name="live555-source-code-analysis-setup-processing" class="anchor-navigation-ex-anchor" href="#live555-source-code-analysis-setup-processing"><i class="fa fa-link" aria-hidden="true"></i></a>1. Live555 Source Code Analysis: SETUP processing</h1>
<p> Posted on 2017-09-05 |  In <a href="https://www.wolfcstech.com/categories/live555/" target="_blank">live555</a></p>
<!-- TOC depthFrom:1 depthTo:6 withLinks:1 updateOnSave:0 orderedList:0 -->
<ul>
<li><a href="#live555-source-code-analysis-setup-processing"><strong>Live555 Source Code Analysis: SETUP processing</strong></a><ul>
<li><a href="#live555-source-code-analysis-series"><strong>Live555 source code analysis series</strong></a></li>
</ul>
</li>
</ul>
<!-- /TOC -->
<p><code>SETUP</code> The request is used to establish a streaming session throughout the RTSP
workflow. This paper analyzes live555 of <code>SETUP</code> processing the request.</p>
<p>in</p>
<p><code>RTSPServer::RTSPClientConnection::handleRequestBytes(intnewBytesRead)</code> By <code>RTSPServer::RTSPClientSession</code> the <code>handleCmd_SETUP()</code> function of processing <code>SETUP</code> the request, as follows:</p>
<div class="ace"><div class="aceCode" data-config="{&quot;edit&quot;:false,&quot;lang&quot;:&quot;c_cpp&quot;,&quot;check&quot;:false,&quot;theme&quot;:&quot;monokai&quot;}">void RTSPServer::RTSPClientSession
::handleCmd_SETUP(RTSPServer::RTSPClientConnection* ourClientConnection,
    char const* urlPreSuffix, char const* urlSuffix, char const* fullRequestStr) {
  // Normally, &quot;urlPreSuffix&quot; should be the session (stream) name, and &quot;urlSuffix&quot; should be the subsession (track) name.
  // However (being &quot;liberal in what we accept&quot;), we also handle &apos;aggregate&apos; SETUP requests (i.e., without a track name),
  // in the special case where we have only a single track.  I.e., in this case, we also handle:
  //    &quot;urlPreSuffix&quot; is empty and &quot;urlSuffix&quot; is the session (stream) name, or
  //    &quot;urlPreSuffix&quot; concatenated with &quot;urlSuffix&quot; (with &quot;/&quot; inbetween) is the session (stream) name.
  char const* streamName = urlPreSuffix; // in the normal case
  char const* trackId = urlSuffix; // in the normal case
  char* concatenatedStreamName = NULL; // in the normal case

  do {
    // First, make sure the specified stream name exists:
    ServerMediaSession* sms
      = fOurServer.lookupServerMediaSession(streamName, fOurServerMediaSession == NULL);
    if (sms == NULL) {
      // Check for the special case (noted above), before we give up:
      if (urlPreSuffix[0] == &apos;\0&apos;) {
        streamName = urlSuffix;
      } else {
        concatenatedStreamName = new char[strlen(urlPreSuffix)
            + strlen(urlSuffix) + 2]; // allow for the &quot;/&quot; and the trailing &apos;\0&apos;
        sprintf(concatenatedStreamName, &quot;%s/%s&quot;, urlPreSuffix, urlSuffix);
        streamName = concatenatedStreamName;
      }
      trackId = NULL;

      // Check again:
      sms = fOurServer.lookupServerMediaSession(streamName, fOurServerMediaSession == NULL);
    }
    if (sms == NULL) {
      if (fOurServerMediaSession == NULL) {
        // The client asked for a stream that doesn&apos;t exist (and this session descriptor has not been used before):
        ourClientConnection-&gt;handleCmd_notFound();
      } else {
        // The client asked for a stream that doesn&apos;t exist, but using a stream id for a stream that does exist. Bad request:
        ourClientConnection-&gt;handleCmd_bad();
      }
      break;
    } else {
      if (fOurServerMediaSession == NULL) {
        // We&apos;re accessing the &quot;ServerMediaSession&quot; for the first time.
        fOurServerMediaSession = sms;
        fOurServerMediaSession-&gt;incrementReferenceCount();
      } else if (sms != fOurServerMediaSession) {
        // The client asked for a stream that&apos;s different from the one originally requested for this stream id.  Bad request:
        ourClientConnection-&gt;handleCmd_bad();
        break;
      }
    }

    if (fStreamStates == NULL) {
      // This is the first &quot;SETUP&quot; for this session.  Set up our array of states for all of this session&apos;s subsessions (tracks):
      fNumStreamStates = fOurServerMediaSession-&gt;numSubsessions();
      fStreamStates = new struct streamState[fNumStreamStates];

      ServerMediaSubsessionIterator iter(*fOurServerMediaSession);
      ServerMediaSubsession* subsession;
      for (unsigned i = 0; i &lt; fNumStreamStates; ++i) {
        subsession = iter.next();
        fStreamStates[i].subsession = subsession;
        fStreamStates[i].tcpSocketNum = -1; // for now; may get set for RTP-over-TCP streaming
        fStreamStates[i].streamToken = NULL; // for now; it may be changed by the &quot;getStreamParameters()&quot; call that comes later
      }
    }

    // Look up information for the specified subsession (track):
    ServerMediaSubsession* subsession = NULL;
    unsigned trackNum;
    if (trackId != NULL &amp;&amp; trackId[0] != &apos;\0&apos;) { // normal case
      for (trackNum = 0; trackNum &lt; fNumStreamStates; ++trackNum) {
        subsession = fStreamStates[trackNum].subsession;
        if (subsession != NULL &amp;&amp; strcmp(trackId, subsession-&gt;trackId()) == 0) break;
      }
      if (trackNum &gt;= fNumStreamStates) {
        // The specified track id doesn&apos;t exist, so this request fails:
        ourClientConnection-&gt;handleCmd_notFound();
        break;
      }
    } else {
      // Weird case: there was no track id in the URL.
      // This works only if we have only one subsession:
      if (fNumStreamStates != 1 || fStreamStates[0].subsession == NULL) {
        ourClientConnection-&gt;handleCmd_bad();
        break;
      }
      trackNum = 0;
      subsession = fStreamStates[trackNum].subsession;
    }
    // ASSERT: subsession != NULL

    void*&amp; token = fStreamStates[trackNum].streamToken; // alias
    if (token != NULL) {
      // We already handled a &quot;SETUP&quot; for this track (to the same client),
      // so stop any existing streaming of it, before we set it up again:
      subsession-&gt;pauseStream(fOurSessionId, token);
      fOurRTSPServer.unnoteTCPStreamingOnSocket(fStreamStates[trackNum].tcpSocketNum, this, trackNum);
      subsession-&gt;deleteStream(fOurSessionId, token);
    }
    // Look for a &quot;Transport:&quot; header in the request string, to extract client parameters:
    StreamingMode streamingMode;
    char* streamingModeString = NULL; // set when RAW_UDP streaming is specified
    char* clientsDestinationAddressStr;
    u_int8_t clientsDestinationTTL;
    portNumBits clientRTPPortNum, clientRTCPPortNum;
    unsigned char rtpChannelId, rtcpChannelId;
    parseTransportHeader(fullRequestStr, streamingMode, streamingModeString,
        clientsDestinationAddressStr, clientsDestinationTTL,
        clientRTPPortNum, clientRTCPPortNum,
        rtpChannelId, rtcpChannelId);
    if ((streamingMode == RTP_TCP &amp;&amp; rtpChannelId == 0xFF)
        || (streamingMode != RTP_TCP &amp;&amp; ourClientConnection-&gt;fClientOutputSocket != ourClientConnection-&gt;fClientInputSocket)) {
      // An anomolous situation, caused by a buggy client.  Either:
      //     1/ TCP streaming was requested, but with no &quot;interleaving=&quot; fields.  (QuickTime Player sometimes does this.), or
      //     2/ TCP streaming was not requested, but we&apos;re doing RTSP-over-HTTP tunneling (which implies TCP streaming).
      // In either case, we assume TCP streaming, and set the RTP and RTCP channel ids to proper values:
      streamingMode = RTP_TCP;
      rtpChannelId = fTCPStreamIdCount; rtcpChannelId = fTCPStreamIdCount+1;
    }
    if (streamingMode == RTP_TCP) fTCPStreamIdCount += 2;

    Port clientRTPPort(clientRTPPortNum);
    Port clientRTCPPort(clientRTCPPortNum);

    // Next, check whether a &quot;Range:&quot; or &quot;x-playNow:&quot; header is present in the request.
    // This isn&apos;t legal, but some clients do this to combine &quot;SETUP&quot; and &quot;PLAY&quot;:
    double rangeStart = 0.0, rangeEnd = 0.0;
    char* absStart = NULL; char* absEnd = NULL;
    Boolean startTimeIsNow;
    if (parseRangeHeader(fullRequestStr, rangeStart, rangeEnd, absStart, absEnd, startTimeIsNow)) {
      delete[] absStart; delete[] absEnd;
      fStreamAfterSETUP = True;
    } else if (parsePlayNowHeader(fullRequestStr)) {
      fStreamAfterSETUP = True;
    } else {
      fStreamAfterSETUP = False;
    }

    // Then, get server parameters from the &apos;subsession&apos;:
    if (streamingMode == RTP_TCP) {
      // Note that we&apos;ll be streaming over the RTSP TCP connection:
      fStreamStates[trackNum].tcpSocketNum = ourClientConnection-&gt;fClientOutputSocket;
      fOurRTSPServer.noteTCPStreamingOnSocket(fStreamStates[trackNum].tcpSocketNum, this, trackNum);
    }
    netAddressBits destinationAddress = 0;
    u_int8_t destinationTTL = 255;
#ifdef RTSP_ALLOW_CLIENT_DESTINATION_SETTING
    if (clientsDestinationAddressStr != NULL) {
      // Use the client-provided &quot;destination&quot; address.
      // Note: This potentially allows the server to be used in denial-of-service
      // attacks, so don&apos;t enable this code unless you&apos;re sure that clients are
      // trusted.
      destinationAddress = our_inet_addr(clientsDestinationAddressStr);
    }
    // Also use the client-provided TTL.
    destinationTTL = clientsDestinationTTL;
#endif
    delete[] clientsDestinationAddressStr;
    Port serverRTPPort(0);
    Port serverRTCPPort(0);

    // Make sure that we transmit on the same interface that&apos;s used by the client (in case we&apos;re a multi-homed server):
    struct sockaddr_in sourceAddr; SOCKLEN_T namelen = sizeof sourceAddr;
    getsockname(ourClientConnection-&gt;fClientInputSocket, (struct sockaddr*)&amp;sourceAddr, &amp;namelen);
    netAddressBits origSendingInterfaceAddr = SendingInterfaceAddr;
    netAddressBits origReceivingInterfaceAddr = ReceivingInterfaceAddr;
    // NOTE: The following might not work properly, so we ifdef it out for now:
#ifdef HACK_FOR_MULTIHOMED_SERVERS
    ReceivingInterfaceAddr = SendingInterfaceAddr = sourceAddr.sin_addr.s_addr;
#endif

    subsession-&gt;getStreamParameters(fOurSessionId, ourClientConnection-&gt;fClientAddr.sin_addr.s_addr,
        clientRTPPort, clientRTCPPort,
        fStreamStates[trackNum].tcpSocketNum, rtpChannelId, rtcpChannelId,
        destinationAddress, destinationTTL, fIsMulticast,
        serverRTPPort, serverRTCPPort,
        fStreamStates[trackNum].streamToken);
    SendingInterfaceAddr = origSendingInterfaceAddr;
    ReceivingInterfaceAddr = origReceivingInterfaceAddr;
    AddressString destAddrStr(destinationAddress);
    AddressString sourceAddrStr(sourceAddr);
    char timeoutParameterString[100];
    if (fOurRTSPServer.fReclamationSeconds &gt; 0) {
      sprintf(timeoutParameterString, &quot;;timeout=%u&quot;,
          fOurRTSPServer.fReclamationSeconds);
    } else {
      timeoutParameterString[0] = &apos;\0&apos;;
    }
    if (fIsMulticast) {
      switch (streamingMode) {
      case RTP_UDP: {
        snprintf((char*) ourClientConnection-&gt;fResponseBuffer, sizeof ourClientConnection-&gt;fResponseBuffer,
            &quot;RTSP/1.0 200 OK\r\n&quot;
            &quot;CSeq: %s\r\n&quot;
            &quot;%s&quot;
            &quot;Transport: RTP/AVP;multicast;destination=%s;source=%s;port=%d-%d;ttl=%d\r\n&quot;
            &quot;Session: %08X%s\r\n\r\n&quot;,
            ourClientConnection-&gt;fCurrentCSeq,
            dateHeader(),
            destAddrStr.val(), sourceAddrStr.val(),
            ntohs(serverRTPPort.num()), ntohs(serverRTCPPort.num()), destinationTTL,
            fOurSessionId, timeoutParameterString);
        break;
      }
      case RTP_TCP: {
        // multicast streams can&apos;t be sent via TCP
        ourClientConnection-&gt;handleCmd_unsupportedTransport();
        break;
      }
      case RAW_UDP: {
        snprintf((char*) ourClientConnection-&gt;fResponseBuffer, sizeof ourClientConnection-&gt;fResponseBuffer,
            &quot;RTSP/1.0 200 OK\r\n&quot;
            &quot;CSeq: %s\r\n&quot;
            &quot;%s&quot;
            &quot;Transport: %s;multicast;destination=%s;source=%s;port=%d;ttl=%d\r\n&quot;
            &quot;Session: %08X%s\r\n\r\n&quot;,
            ourClientConnection-&gt;fCurrentCSeq,
            dateHeader(),
            streamingModeString, destAddrStr.val(), sourceAddrStr.val(), ntohs(serverRTPPort.num()), destinationTTL,
            fOurSessionId, timeoutParameterString);
        break;
      }
      }
    } else {
      switch (streamingMode) {
      case RTP_UDP: {
        snprintf((char*) ourClientConnection-&gt;fResponseBuffer, sizeof ourClientConnection-&gt;fResponseBuffer,
            &quot;RTSP/1.0 200 OK\r\n&quot;
            &quot;CSeq: %s\r\n&quot;
            &quot;%s&quot;
            &quot;Transport: RTP/AVP;unicast;destination=%s;source=%s;client_port=%d-%d;server_port=%d-%d\r\n&quot;
            &quot;Session: %08X%s\r\n\r\n&quot;,
            ourClientConnection-&gt;fCurrentCSeq,
            dateHeader(),
            destAddrStr.val(), sourceAddrStr.val(), ntohs(clientRTPPort.num()), ntohs(clientRTCPPort.num()), ntohs(serverRTPPort.num()), ntohs(serverRTCPPort.num()),
            fOurSessionId, timeoutParameterString);
        break;
      }
      case RTP_TCP: {
        if (!fOurRTSPServer.fAllowStreamingRTPOverTCP) {
          ourClientConnection-&gt;handleCmd_unsupportedTransport();
        } else {
          snprintf((char*) ourClientConnection-&gt;fResponseBuffer, sizeof ourClientConnection-&gt;fResponseBuffer,
              &quot;RTSP/1.0 200 OK\r\n&quot;
              &quot;CSeq: %s\r\n&quot;
              &quot;%s&quot;
              &quot;Transport: RTP/AVP/TCP;unicast;destination=%s;source=%s;interleaved=%d-%d\r\n&quot;
              &quot;Session: %08X%s\r\n\r\n&quot;,
              ourClientConnection-&gt;fCurrentCSeq,
              dateHeader(),
              destAddrStr.val(), sourceAddrStr.val(), rtpChannelId, rtcpChannelId,
              fOurSessionId, timeoutParameterString);
        }
        break;
      }
      case RAW_UDP: {
        snprintf((char*) ourClientConnection-&gt;fResponseBuffer,
            sizeof ourClientConnection-&gt;fResponseBuffer,
            &quot;RTSP/1.0 200 OK\r\n&quot;
            &quot;CSeq: %s\r\n&quot;
            &quot;%s&quot;
            &quot;Transport: %s;unicast;destination=%s;source=%s;client_port=%d;server_port=%d\r\n&quot;
            &quot;Session: %08X%s\r\n\r\n&quot;,
            ourClientConnection-&gt;fCurrentCSeq,
            dateHeader(),
            streamingModeString, destAddrStr.val(), sourceAddrStr.val(), ntohs(clientRTPPort.num()), ntohs(serverRTPPort.num()),
            fOurSessionId, timeoutParameterString);
        break;
      }
      }
    }
    delete[] streamingModeString;
  } while (0);
  delete[] concatenatedStreamName;
}<br></div></div>

<p>The first step, in this function, first find the corresponding
resource <code>ServerMediaSession</code>, first try to find the part of the resource path
that does not contain the track id, if it fails, it will find the full path of
the resource:</p>
<div class="ace"><div class="aceCode" data-config="{&quot;edit&quot;:false,&quot;lang&quot;:&quot;c_cpp&quot;,&quot;check&quot;:false,&quot;theme&quot;:&quot;monokai&quot;}">ServerMediaSession* sms
  = fOurServer.lookupServerMediaSession(streamName, fOurServerMediaSession == NULL);
if (sms == NULL) {
  // Check for the special case (noted above), before we give up:
  if (urlPreSuffix[0] == &apos;\0&apos;) {
    streamName = urlSuffix;
  } else {
    concatenatedStreamName = new char[strlen(urlPreSuffix)
        + strlen(urlSuffix) + 2]; // allow for the &quot;/&quot; and the trailing &apos;\0&apos;
    sprintf(concatenatedStreamName, &quot;%s/%s&quot;, urlPreSuffix, urlSuffix);
    streamName = concatenatedStreamName;
  }
  trackId = NULL;

  // Check again:
  sms = fOurServer.lookupServerMediaSession(streamName, fOurServerMediaSession == NULL);
}<br></div></div>


<p>it&apos;s here</p>
<p><code>lookupServerMediaSession(char const* streamName, boolean isFirstLookupInSession)</code>
The <code>isFirstLookupInSessionargument</code> is no longer the
default value, but rather based on <code>fOurServerMediaSession</code> the value determined.</p>
<p>Visible in the process <code>DESCRIBE</code> created when the request ServerMediaSessionwill
always be destroyed and rebuilt.</p>
<p>In the second step, the fault-tolerant processing or update status is performed
according to the search result of the previous step.</p>
<p>If find or create <code>ServerMediaSession</code> fails, and <code>fOurServerMediaSession</code> is empty,
an error returned to the client 404, this situation is more easily understood,
i.e. <code>DESCRIBE</code> after the request, the resource is removed; or if create
lookup <code>ServerMediaSession</code> fails, and <code>fOurServerMediaSession</code> is non-empty, then
this time the 400 client returns an error, this scenario seems to be that
perform a number of <code>SETUP</code> operations performed when the resources for the first
time in, but when performed behind the resources do not exist.</p>
<p>Find or create a <code>ServerMediaSession</code> failure always causes the function to return
early.</p>
<div class="ace"><div class="aceCode" data-config="{&quot;edit&quot;:false,&quot;lang&quot;:&quot;c_cpp&quot;,&quot;check&quot;:false,&quot;theme&quot;:&quot;monokai&quot;}">if (sms == NULL) {
  if (fOurServerMediaSession == NULL) {
    // The client asked for a stream that doesn&apos;t exist (and this session descriptor has not been used before):
    ourClientConnection-&gt;handleCmd_notFound();
  } else {
    // The client asked for a stream that doesn&apos;t exist, but using a stream id for a stream that does exist. Bad request:
    ourClientConnection-&gt;handleCmd_bad();
  }
  break;
} else {<br></div></div>

<p>To find or create <code>ServerMediaSession</code> a successful situation, if this
time <code>fOurServerMediaSession</code> is empty, indicating that this is the streaming media
session for the first time to perform <code>SETUP</code> the operation, this time to
update <code>fOurServerMediaSession</code> and increase its reference count;
if <code>fOurServerMediaSession</code> not empty, and find different, then the customer The
end returns a 400 error response message, <em>not quite sure what the scene is</em> .</p>
<p>The third part, create a flow state as needed. Create a stream state structure
for each subsession of the streaming media streamState.</p>
<div class="ace"><div class="aceCode" data-config="{&quot;edit&quot;:false,&quot;lang&quot;:&quot;c_cpp&quot;,&quot;check&quot;:false,&quot;theme&quot;:&quot;monokai&quot;}">if (fStreamStates == NULL) {
  // This is the first &quot;SETUP&quot; for this session.  Set up our array of states for all of this session&apos;s subsessions (tracks):
  fNumStreamStates = fOurServerMediaSession-&gt;numSubsessions();
  fStreamStates = new struct streamState[fNumStreamStates];

  ServerMediaSubsessionIterator iter(*fOurServerMediaSession);
  ServerMediaSubsession* subsession;
  for (unsigned i = 0; i &lt; fNumStreamStates; ++i) {
    subsession = iter.next();
    fStreamStates[i].subsession = subsession;
    fStreamStates[i].tcpSocketNum = -1; // for now; may get set for RTP-over-TCP streaming
    fStreamStates[i].streamToken = NULL; // for now; it may be changed by the &quot;getStreamParameters()&quot; call that comes later
  }
}<br></div></div>

<p>The fourth step is to find information about a specific sub-track. For a request
with a track id in the URL, it is searched according to the track id, otherwise
it is used as a track session for the case of only one child session.</p>
<div class="ace"><div class="aceCode" data-config="{&quot;edit&quot;:false,&quot;lang&quot;:&quot;c_cpp&quot;,&quot;check&quot;:false,&quot;theme&quot;:&quot;monokai&quot;}">// Look up information for the specified subsession (track):
ServerMediaSubsession* subsession = NULL;
unsigned trackNum;
if (trackId != NULL &amp;&amp; trackId[0] != &apos;\0&apos;) { // normal case
  for (trackNum = 0; trackNum &lt; fNumStreamStates; ++trackNum) {
    subsession = fStreamStates[trackNum].subsession;
    if (subsession != NULL &amp;&amp; strcmp(trackId, subsession-&gt;trackId()) == 0) break;
  }
  if (trackNum &gt;= fNumStreamStates) {
    // The specified track id doesn&apos;t exist, so this request fails:
    ourClientConnection-&gt;handleCmd_notFound();
    break;
  }
} else {
  // Weird case: there was no track id in the URL.
  // This works only if we have only one subsession:
  if (fNumStreamStates != 1 || fStreamStates[0].subsession == NULL) {
    ourClientConnection-&gt;handleCmd_bad();
    break;
  }
  trackNum = 0;
  subsession = fStreamStates[trackNum].subsession;
}<br></div></div>

<p>A fifth step, if a non-null token track sub-session, indicating that track has
been treated <code>SETUP</code> prior to the request, then it is reset, to stop its existing
stream.</p>
<div class="ace"><div class="aceCode" data-config="{&quot;edit&quot;:false,&quot;lang&quot;:&quot;c_cpp&quot;,&quot;check&quot;:false,&quot;theme&quot;:&quot;monokai&quot;}">void*&amp; token = fStreamStates[trackNum].streamToken; // alias
if (token != NULL) {
  // We already handled a &quot;SETUP&quot; for this track (to the same client),
  // so stop any existing streaming of it, before we set it up again:
  subsession-&gt;pauseStream(fOurSessionId, token);
  fOurRTSPServer.unnoteTCPStreamingOnSocket(fStreamStates[trackNum].tcpSocketNum, this, trackNum);
  subsession-&gt;deleteStream(fOurSessionId, token);
}<br></div></div>

<p>The specific operation process of the control of streaming media in the session
is not analyzed in detail for the time being.</p>
<p>The sixth step, find the string from the request Transport:header and extracts
the client parameters. <code>SETUP</code> Request Transport:header might look like this:</p>
<pre><code>Transport: RTP/AVP/UDP;unicast;client_port=19586-19587
</code></pre><p>In this header, there is a way of communication, whether UDP is unicast or
multicast, and the port number used by the client to send and receive RTP/RTCP
packets.</p>
<div class="ace"><div class="aceCode" data-config="{&quot;edit&quot;:false,&quot;lang&quot;:&quot;c_cpp&quot;,&quot;check&quot;:false,&quot;theme&quot;:&quot;monokai&quot;}">typedef enum StreamingMode {
  RTP_UDP,
  RTP_TCP,
  RAW_UDP
} StreamingMode;
static void parseTransportHeader(char const* buf,
    StreamingMode&amp; streamingMode,
    char*&amp; streamingModeString,
    char*&amp; destinationAddressStr,
    u_int8_t&amp; destinationTTL,
    portNumBits&amp; clientRTPPortNum, // if UDP
    portNumBits&amp; clientRTCPPortNum, // if UDP
    unsigned char&amp; rtpChannelId, // if TCP
    unsigned char&amp; rtcpChannelId // if TCP
    ) {
  // Initialize the result parameters to default values:
  streamingMode = RTP_UDP;
  streamingModeString = NULL;
  destinationAddressStr = NULL;
  destinationTTL = 255;
  clientRTPPortNum = 0;
  clientRTCPPortNum = 1;
  rtpChannelId = rtcpChannelId = 0xFF;

  portNumBits p1, p2;
  unsigned ttl, rtpCid, rtcpCid;

  // First, find &quot;Transport:&quot;
  while (1) {
    if (*buf == &apos;\0&apos;) return; // not found
    if (*buf == &apos;\r&apos; &amp;&amp; *(buf+1) == &apos;\n&apos; &amp;&amp; *(buf+2) == &apos;\r&apos;) return; // end of the headers =&gt; not found
    if (_strncasecmp(buf, &quot;Transport:&quot;, 10) == 0) break;
    ++buf;
  }

  // Then, run through each of the fields, looking for ones we handle:
  char const* fields = buf + 10;
  while (*fields == &apos; &apos;) ++fields;
  char* field = strDupSize(fields);
  while (sscanf(fields, &quot;%[^;\r\n]&quot;, field) == 1) {
    if (strcmp(field, &quot;RTP/AVP/TCP&quot;) == 0) {
      streamingMode = RTP_TCP;
    } else if (strcmp(field, &quot;RAW/RAW/UDP&quot;) == 0
        || strcmp(field, &quot;MP2T/H2221/UDP&quot;) == 0) {
      streamingMode = RAW_UDP;
      streamingModeString = strDup(field);
    } else if (_strncasecmp(field, &quot;destination=&quot;, 12) == 0) {
      delete[] destinationAddressStr;
      destinationAddressStr = strDup(field+12);
    } else if (sscanf(field, &quot;ttl%u&quot;, &amp;ttl) == 1) {
      destinationTTL = (u_int8_t)ttl;
    } else if (sscanf(field, &quot;client_port=%hu-%hu&quot;, &amp;p1, &amp;p2) == 2) {
      clientRTPPortNum = p1;
      clientRTCPPortNum = streamingMode == RAW_UDP ? 0 : p2; // ignore the second port number if the client asked for raw UDP
    } else if (sscanf(field, &quot;client_port=%hu&quot;, &amp;p1) == 1) {
      clientRTPPortNum = p1;
      clientRTCPPortNum = streamingMode == RAW_UDP ? 0 : p1 + 1;
    } else if (sscanf(field, &quot;interleaved=%u-%u&quot;, &amp;rtpCid, &amp;rtcpCid) == 2) {
      rtpChannelId = (unsigned char)rtpCid;
      rtcpChannelId = (unsigned char)rtcpCid;
    }

    fields += strlen(field);
    while (*fields == &apos;;&apos; || *fields == &apos; &apos; || *fields == &apos;\t&apos;) ++fields; // skip over separating &apos;;&apos; chars or whitespace
    if (*fields == &apos;\0&apos; || *fields == &apos;\r&apos; || *fields == &apos;\n&apos;) break;
  }
  delete[] field;
}
. . . . . .
    // Look for a &quot;Transport:&quot; header in the request string, to extract client parameters:
    StreamingMode streamingMode;
    char* streamingModeString = NULL; // set when RAW_UDP streaming is specified
    char* clientsDestinationAddressStr;
    u_int8_t clientsDestinationTTL;
    portNumBits clientRTPPortNum, clientRTCPPortNum;
    unsigned char rtpChannelId, rtcpChannelId;
    parseTransportHeader(fullRequestStr, streamingMode, streamingModeString,
        clientsDestinationAddressStr, clientsDestinationTTL,
        clientRTPPortNum, clientRTCPPortNum,
        rtpChannelId, rtcpChannelId);
    if ((streamingMode == RTP_TCP &amp;&amp; rtpChannelId == 0xFF)
        || (streamingMode != RTP_TCP &amp;&amp; ourClientConnection-&gt;fClientOutputSocket != ourClientConnection-&gt;fClientInputSocket)) {
      // An anomolous situation, caused by a buggy client.  Either:
      //     1/ TCP streaming was requested, but with no &quot;interleaving=&quot; fields.  (QuickTime Player sometimes does this.), or
      //     2/ TCP streaming was not requested, but we&apos;re doing RTSP-over-HTTP tunneling (which implies TCP streaming).
      // In either case, we assume TCP streaming, and set the RTP and RTCP channel ids to proper values:
      streamingMode = RTP_TCP;
      rtpChannelId = fTCPStreamIdCount; rtcpChannelId = fTCPStreamIdCount+1;
    }
    if (streamingMode == RTP_TCP) fTCPStreamIdCount += 2;

    Port clientRTPPort(clientRTPPortNum);
    Port clientRTCPPort(clientRTCPPortNum);<br></div></div>

<p>In our earlier example <code>Transport:</code> of the head, you can see &quot;unicast&quot;, but in
live555, rather than according <code>Transport:</code> to determine the flow unicast or
multicast content head.</p>
<p>Whether there is a seventh step, check request <code>Range:</code> or <code>x-playNow:</code> head. This is
not the standard RTSP support the practice, but some clients may be put in this
way <code>SETUP</code> and <code>PLAY</code> together.</p>
<div class="ace"><div class="aceCode" data-config="{&quot;edit&quot;:false,&quot;lang&quot;:&quot;c_cpp&quot;,&quot;check&quot;:false,&quot;theme&quot;:&quot;monokai&quot;}">Boolean parseRangeParam(char const* paramStr,
            double&amp; rangeStart, double&amp; rangeEnd,
            char*&amp; absStartTime, char*&amp; absEndTime,
            Boolean&amp; startTimeIsNow) {
  delete[] absStartTime; delete[] absEndTime;
  absStartTime = absEndTime = NULL; // by default, unless &quot;paramStr&quot; is a &quot;clock=...&quot; string
  startTimeIsNow = False; // by default
  double start, end;
  int numCharsMatched1 = 0, numCharsMatched2 = 0, numCharsMatched3 = 0, numCharsMatched4 = 0;
  Locale l(&quot;C&quot;, Numeric);
  if (sscanf(paramStr, &quot;npt = %lf - %lf&quot;, &amp;start, &amp;end) == 2) {
    rangeStart = start;
    rangeEnd = end;
  } else if (sscanf(paramStr, &quot;npt = %n%lf -&quot;, &amp;numCharsMatched1, &amp;start) == 1) {
    if (paramStr[numCharsMatched1] == &apos;-&apos;) {
      // special case for &quot;npt = -&lt;endtime&gt;&quot;, which matches here:
      rangeStart = 0.0; startTimeIsNow = True;
      rangeEnd = -start;
    } else {
      rangeStart = start;
      rangeEnd = 0.0;
    }
  } else if (sscanf(paramStr, &quot;npt = now - %lf&quot;, &amp;end) == 1) {
      rangeStart = 0.0; startTimeIsNow = True;
      rangeEnd = end;
  } else if (sscanf(paramStr, &quot;npt = now -%n&quot;, &amp;numCharsMatched2) == 0 &amp;&amp; numCharsMatched2 &gt; 0) {
    rangeStart = 0.0; startTimeIsNow = True;
    rangeEnd = 0.0;
  } else if (sscanf(paramStr, &quot;clock = %n&quot;, &amp;numCharsMatched3) == 0 &amp;&amp; numCharsMatched3 &gt; 0) {
    rangeStart = rangeEnd = 0.0;
    char const* utcTimes = &amp;paramStr[numCharsMatched3];
    size_t len = strlen(utcTimes) + 1;
    char* as = new char[len];
    char* ae = new char[len];
    int sscanfResult = sscanf(utcTimes, &quot;%[^-]-%[^\r\n]&quot;, as, ae);
    if (sscanfResult == 2) {
      absStartTime = as;
      absEndTime = ae;
    } else if (sscanfResult == 1) {
      absStartTime = as;
      delete[] ae;
    } else {
      delete[] as; delete[] ae;
      return False;
    }
  } else if (sscanf(paramStr, &quot;smtpe = %n&quot;, &amp;numCharsMatched4) == 0 &amp;&amp; numCharsMatched4 &gt; 0) {
    // We accept &quot;smtpe=&quot; parameters, but currently do not interpret them.
  } else {
    return False; // The header is malformed
  }
  return True;
}
Boolean parseRangeHeader(char const* buf,
             double&amp; rangeStart, double&amp; rangeEnd,
             char*&amp; absStartTime, char*&amp; absEndTime,
             Boolean&amp; startTimeIsNow) {
  // First, find &quot;Range:&quot;
  while (1) {
    if (*buf == &apos;\0&apos;) return False; // not found
    if (_strncasecmp(buf, &quot;Range: &quot;, 7) == 0) break;
    ++buf;
  }
  char const* fields = buf + 7;
  while (*fields == &apos; &apos;) ++fields;
  return parseRangeParam(fields, rangeStart, rangeEnd, absStartTime, absEndTime, startTimeIsNow);
}
. . . . . .
static Boolean parsePlayNowHeader(char const* buf) {
  // Find &quot;x-playNow:&quot; header, if present
  while (1) {
    if (*buf == &apos;\0&apos;) return False; // not found
    if (_strncasecmp(buf, &quot;x-playNow:&quot;, 10) == 0) break;
    ++buf;
  }

  return True;
}
. . . . . .
    double rangeStart = 0.0, rangeEnd = 0.0;
    char* absStart = NULL; char* absEnd = NULL;
    Boolean startTimeIsNow;
    if (parseRangeHeader(fullRequestStr, rangeStart, rangeEnd, absStart, absEnd, startTimeIsNow)) {
      delete[] absStart; delete[] absEnd;
      fStreamAfterSETUP = True;
    } else if (parsePlayNowHeader(fullRequestStr)) {
      fStreamAfterSETUP = True;
    } else {
      fStreamAfterSETUP = False;
    }<br></div></div>

<p>Although RTP/RTCP also supports TCP mode, this approach is not very mainstream.
Later we mainly look at the UDP unicast-based mode.</p>
<p>The eighth step is to allocate network resources for the session, such as
server-side RTP and RTCP ports.</p>
<div class="ace"><div class="aceCode" data-config="{&quot;edit&quot;:false,&quot;lang&quot;:&quot;c_cpp&quot;,&quot;check&quot;:false,&quot;theme&quot;:&quot;monokai&quot;}">netAddressBits destinationAddress = 0;
u_int8_t destinationTTL = 255;
#ifdef RTSP_ALLOW_CLIENT_DESTINATION_SETTING
if (clientsDestinationAddressStr != NULL) {
  // Use the client-provided &quot;destination&quot; address.
  // Note: This potentially allows the server to be used in denial-of-service
  // attacks, so don&apos;t enable this code unless you&apos;re sure that clients are
  // trusted.
  destinationAddress = our_inet_addr(clientsDestinationAddressStr);
}
// Also use the client-provided TTL.
destinationTTL = clientsDestinationTTL;
#endif
delete[] clientsDestinationAddressStr;
Port serverRTPPort(0);
Port serverRTCPPort(0);

// Make sure that we transmit on the same interface that&apos;s used by the client (in case we&apos;re a multi-homed server):
struct sockaddr_in sourceAddr; SOCKLEN_T namelen = sizeof sourceAddr;
getsockname(ourClientConnection-&gt;fClientInputSocket, (struct sockaddr*)&amp;sourceAddr, &amp;namelen);
netAddressBits origSendingInterfaceAddr = SendingInterfaceAddr;
netAddressBits origReceivingInterfaceAddr = ReceivingInterfaceAddr;
// NOTE: The following might not work properly, so we ifdef it out for now:
#ifdef HACK_FOR_MULTIHOMED_SERVERS
ReceivingInterfaceAddr = SendingInterfaceAddr = sourceAddr.sin_addr.s_addr;
#endif

subsession-&gt;getStreamParameters(fOurSessionId, ourClientConnection-&gt;fClientAddr.sin_addr.s_addr,
    clientRTPPort, clientRTCPPort,
    fStreamStates[trackNum].tcpSocketNum, rtpChannelId, rtcpChannelId,
    destinationAddress, destinationTTL, fIsMulticast,
    serverRTPPort, serverRTCPPort,
    fStreamStates[trackNum].streamToken);
SendingInterfaceAddr = origSendingInterfaceAddr;
ReceivingInterfaceAddr = origReceivingInterfaceAddr;
AddressString destAddrStr(destinationAddress);
AddressString sourceAddrStr(sourceAddr);<br></div></div>

<p>Later we come to analyze <code>H264VideoFileServerMediaSubsession</code> the process in more
detail.</p>
<p>In the ninth step, a timeout parameter string is generated.</p>
<div class="ace"><div class="aceCode" data-config="{&quot;edit&quot;:false,&quot;lang&quot;:&quot;c_cpp&quot;,&quot;check&quot;:false,&quot;theme&quot;:&quot;monokai&quot;}">if (fOurRTSPServer.fReclamationSeconds &gt; 0) {
  sprintf(timeoutParameterString, &quot;;timeout=%u&quot;,
      fOurRTSPServer.fReclamationSeconds);
} else {
  timeoutParameterString[0] = &apos;\0&apos;;
}<br></div></div>

<p>In the tenth step, a response message is generated. We only look at the
generation of RTP UDP unicast mode response messages.</p>
<div class="ace"><div class="aceCode" data-config="{&quot;edit&quot;:false,&quot;lang&quot;:&quot;c_cpp&quot;,&quot;check&quot;:false,&quot;theme&quot;:&quot;monokai&quot;}">} else {
  switch (streamingMode) {
  case RTP_UDP: {
    snprintf((char*) ourClientConnection-&gt;fResponseBuffer, sizeof ourClientConnection-&gt;fResponseBuffer,
        &quot;RTSP/1.0 200 OK\r\n&quot;
        &quot;CSeq: %s\r\n&quot;
        &quot;%s&quot;
        &quot;Transport: RTP/AVP;unicast;destination=%s;source=%s;client_port=%d-%d;server_port=%d-%d\r\n&quot;
        &quot;Session: %08X%s\r\n\r\n&quot;,
        ourClientConnection-&gt;fCurrentCSeq,
        dateHeader(),
        destAddrStr.val(), sourceAddrStr.val(), ntohs(clientRTPPort.num()), ntohs(clientRTCPPort.num()), ntohs(serverRTPPort.num()), ntohs(serverRTCPPort.num()),
        fOurSessionId, timeoutParameterString);
    break;
  }<br></div></div>

<p>The generated message looks like this:</p>
<pre><code>RTSP/1.0 200 OK
CSeq: 3
Date: Sat, Sep 02 2017 08:54:03 GMT
Transport: RTP/AVP;unicast;destination=10.240.248.20;source=10.240.248.20;client_port=19586-19587;server_port=6970-6971
Session: D10C8C71;timeout=65
</code></pre><p>By <code>Transport:</code> the negotiation of communication parameters, such as the server for
the session allocated UDP ports for transmitting and receiving RTP/RTCP
packets.</p>
<p>Put aside the fault tolerance and summarize the general processing flow of the
<code>SETUP</code> request:</p>
<ol>
<li><p>Created for the session ServerMediaSession.</p>
</li>
<li><p>Resolution request header <code>Transport:</code> content transmission method on the
client request included, such as by using TCP or UDP transport transmission,
the client is opened RTP / RTCP transmission ports.</p>
</li>
<li><p>Resolution request header Range:and x-playNow:to
support <code>SETUP</code> and <code>PLAY</code> combined.</p>
</li>
<li><p>Allocate network resources to the session, such as the RTP/RTCP port on the
server side.</p>
</li>
<li><p>Generate a response message.</p>
</li>
</ol>
<p>In <code>ServerMediaSubsession</code>, some of the process in more detail, the rear left
analysis.</p>
<p><a href="https://www.wolfcstech.com/about/donate.html" target="_blank">Reward</a></p>
<p>Done.</p>
<h2 id="live555-source-code-analysis-series"><a name="live555-source-code-analysis-series" class="anchor-navigation-ex-anchor" href="#live555-source-code-analysis-series"><i class="fa fa-link" aria-hidden="true"></i></a>1.1. Live555 source code analysis series</h2>
<ol>
<li><a href="Live555%20-%20Live555%20source%20code%20analysis_introduction.html">Live555 Source code analysis: Introduction </a></li>
<li><a href="Live555%20-%20Live555%20source%20code%20analysis_infrastructure.html">live555 Source code analysis: Infrastructure </a></li>
<li><a href="Live555%20-%20Live555%20source%20code%20analysis_mediaserver.html">live555 Source code analysis: MediaSever </a></li>
<li><a href="Live555%20-%20Wireshark%20capture%20packet%20analysis%20RTSP_RTP_RTCP%20basic%20working%20process.html">Wireshark capture packet analysis RTSP/RTP/RTCP Basic working process </a></li>
<li><a href="Live555%20-%20Live555%20source%20code%20analysis_rtspserver.html">live555 Source code analysis: RTSPServer </a></li>
<li><a href="Live555%20-%20Live555%20source%20code%20analysis_describe%20processing.html">live555 Source code analysis: DESCRIBE processing </a></li>
<li><a href="https://www.wolfcstech.com/2017/09/05/live555_src_analysis_setup/" target="_blank">live555 Source code analysis: SETUP processing </a></li>
<li><a href="Live555%20-%20Live555%20source%20code%20analysis_play%20processing.html">live555 Source code analysis :PLAY processing </a></li>
<li><a href="Live555%20-%20Live555%20source%20code%20analysis_RTSPServer%20component%20structure.html">live555 Source code analysis: RTSPServer component structure </a></li>
<li><a href="Live555%20-%20Live555%20source%20code%20analysis_servermediasession.html">live555 Source code analysis: </a></li>
<li><a href="Live555%20-%20Live555%20source%20code%20analysis_subsession%20SDP%20line%20generation.html">ServerMediaSession live555 Source code analysis: sub-session SDP line generation </a></li>
<li><a href="Live555%20-%20Live555%20source%20code%20analysis_Subsession%20SETUP.html">live555 Source code analysis: sub-session SETUP </a></li>
<li><a href="Live555%20-%20Live555%20source%20code%20analysis_play%20start.html">live555 Source code analysis: play start</a></li>
</ol>

                                
                                </section>
                            
    </div>
    <div class="search-results">
        <div class="has-results">
            
            <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
            <ul class="search-results-list"></ul>
            
        </div>
        <div class="no-results">
            
            <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
            
        </div>
    </div>
</div>

                        </div>
                    </div>
                
            </div>

            
                
                <a href="Live555 - Live555 source code analysis_describe processing.html" class="navigation navigation-prev " aria-label="Previous page: Live555 - Live555 source code analysis_describe processing">
                    <i class="fa fa-angle-left"></i>
                </a>
                
                
                <a href="Live555 - Live555 source code analysis_play processing.html" class="navigation navigation-next " aria-label="Next page: Live555 - Live555 source code analysis_play processing">
                    <i class="fa fa-angle-right"></i>
                </a>
                
            
        
    </div>

    <script>
        var gitbook = gitbook || [];
        gitbook.push(function() {
            gitbook.page.hasChanged({"page":{"title":"Live555 - Live555 source code analysis_setup processing","level":"1.10.7","depth":2,"next":{"title":"Live555 - Live555 source code analysis_play processing","level":"1.10.8","depth":2,"path":"Live555 - Live555 source code analysis_play processing.md","ref":"Live555 - Live555 source code analysis_play processing.md","articles":[]},"previous":{"title":"Live555 - Live555 source code analysis_describe processing","level":"1.10.6","depth":2,"path":"Live555 - Live555 source code analysis_describe processing.md","ref":"Live555 - Live555 source code analysis_describe processing.md","articles":[]},"dir":"ltr"},"config":{"plugins":["include-html","fancybox","anchor-navigation-ex-toc","ace","-lunr","-search","search-plus","hide-published-with","splitter","expandable-chapters-interactive","wide-page"],"root":"./docs","styles":{"website":"styles/website.css"},"pluginsConfig":{"fancybox":{"helpers":{"buttons":{}}},"ace":{},"splitter":{},"wide-page":{},"anchor-navigation-ex-toc":{"showLevel":true,"associatedWithSummary":true,"mode":"float","printLog":false,"multipleH1":true,"float":{"showLevelIcon":false,"level1Icon":"","level2Icon":"","level3Icon":""},"pageTop":{"showLevelIcon":false,"level1Icon":"","level2Icon":"","level3Icon":""}},"hide-published-with":{},"include-html":{},"fontsettings":{"theme":"white","family":"sans","size":2},"highlight":{},"expandable-chapters-interactive":{},"sharing":{"facebook":true,"twitter":true,"google":false,"weibo":false,"instapaper":false,"vk":false,"all":["facebook","google","twitter","weibo","instapaper"]},"theme-default":{"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"showLevel":false},"expandable-chapters":{},"search-plus":{}},"theme":"default","pdf":{"pageNumbers":true,"fontSize":12,"fontFamily":"Arial","paperSize":"a4","chapterMark":"pagebreak","pageBreaksBefore":"/","margin":{"right":62,"left":62,"top":56,"bottom":56}},"structure":{"langs":"LANGS.md","readme":"README.md","glossary":"GLOSSARY.md","summary":"SUMMARY.md"},"variables":{},"gitbook":"*"},"file":{"path":"Live555 - Live555 source code analysis_setup processing.md","mtime":"2019-03-05T06:19:34.785Z","type":"markdown"},"gitbook":{"version":"3.3.6","time":"2023-12-10T09:35:29.798Z"},"basePath":".","book":{"language":""}});
        });
    </script>
</div>

        
    <script src="gitbook/gitbook.js"></script>
    <script src="gitbook/theme.js"></script>
    
        
        <script src="gitbook/gitbook-plugin-fancybox/jquery.min.js"></script>
        
    
        
        <script src="gitbook/gitbook-plugin-fancybox/jquery.mousewheel.pack.js"></script>
        
    
        
        <script src="gitbook/gitbook-plugin-fancybox/jquery.fancybox.pack.js"></script>
        
    
        
        <script src="gitbook/gitbook-plugin-fancybox/jquery.fancybox-buttons.js"></script>
        
    
        
        <script src="gitbook/gitbook-plugin-fancybox/plugin.js"></script>
        
    
        
        <script src="gitbook/gitbook-plugin-ace/ace/ace.js"></script>
        
    
        
        <script src="gitbook/gitbook-plugin-ace/ace.js"></script>
        
    
        
        <script src="gitbook/gitbook-plugin-search-plus/jquery.mark.min.js"></script>
        
    
        
        <script src="gitbook/gitbook-plugin-search-plus/search.js"></script>
        
    
        
        <script src="gitbook/gitbook-plugin-hide-published-with/plugin.js"></script>
        
    
        
        <script src="gitbook/gitbook-plugin-splitter/splitter.js"></script>
        
    
        
        <script src="gitbook/gitbook-plugin-expandable-chapters-interactive/expandable-chapters.js"></script>
        
    
        
        <script src="gitbook/@gitbook-ng/gitbook-plugin-sharing/buttons.js"></script>
        
    
        
        <script src="gitbook/gitbook-plugin-fontsettings/fontsettings.js"></script>
        
    

    </body>
</html>

